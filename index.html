<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金資料彙總報告產生器 (v3 - 帶預覽功能)</title>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* --- 整體頁面樣式 --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 2em;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
        }
        .container { max-width: 1200px; width: 100%; background: white; padding: 2.5em; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); }
        h1 { color: #1a2c4e; border-bottom: 3px solid #007bff; padding-bottom: 15px; margin-top: 0; }

        /* --- 拖曳區域樣式 --- */
        #drop-zone { border: 3px dashed #c0cdda; border-radius: 10px; padding: 50px; text-align: center; color: #8a9bb3; font-size: 1.3em; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); margin-bottom: 2em; background-color: #fcfdff; }
        #drop-zone.drag-over { border-color: #007bff; background-color: #e6f2ff; color: #0056b3; transform: scale(1.02); }
        #drop-zone p { margin: 0; font-size: 1.5rem; font-weight: 500;}
        #drop-zone span { font-size: 1rem; }

        /* --- 控制項樣式 --- */
        .controls { margin-bottom: 2em; padding: 1.5em; background-color: #f8f9fa; border-radius: 8px; display: flex; flex-direction: column; gap: 20px; }
        .control-row { display: flex; align-items: center; flex-wrap: wrap; gap: 20px; }
        .control-group { display: flex; align-items: center; gap: 10px; }
        label { font-size: 1.1em; font-weight: 500; white-space: nowrap; }
        select, button, input[type="text"] { padding: 12px 18px; font-size: 1em; border-radius: 6px; border: 1px solid #ced4da; transition: all 0.2s ease-in-out; }
        select { cursor: pointer; }
        input[type="text"] { flex-grow: 1; min-width: 120px; }
        select:focus, button:focus, input[type="text"]:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        button { background-color: #28a745; color: white; border-color: #28a745; font-weight: 500; cursor: pointer; }
        #download-json-btn { background-color: #007bff; border-color: #007bff; }
        #process-btn { background-color: #fd7e14; border-color: #fd7e14; }
        #preview-btn { background-color: #17a2b8; border-color: #17a2b8; } /* *** 新增 *** */
        button:hover:not(:disabled) { opacity: 0.85; }
        button:disabled { background-color: #c0cdda; border-color: #c0cdda; cursor: not-allowed; }

        /* --- 模式切換樣式 --- */
        .mode-selector { display: flex; background-color: #e9ecef; border-radius: 6px; padding: 5px; }
        /* ... (略) ... */

        /* --- 狀態和表格樣式 --- */
        #status { margin-bottom: 1.5em; color: #555; font-weight: bold; height: 20px; }
        
        /* --- *** 新增：預覽區域樣式 *** --- */
        #preview-container {
            max-height: 500px;
            overflow: auto;
            border: 1px solid #ced4da;
            border-radius: 8px;
            margin-bottom: 2em;
        }
        #preview-container table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9em;
        }
        #preview-container th, #preview-container td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            white-space: nowrap;
        }
        /* 實現行列凍結的關鍵 */
        #preview-container thead th {
            position: -webkit-sticky; /* Safari */
            position: sticky;
            top: 0;
            background-color: #e9ecef;
            z-index: 2;
        }
        #preview-container tbody th {
            position: -webkit-sticky; /* Safari */
            position: sticky;
            left: 0;
            background-color: #e9ecef;
            z-index: 1;
        }
        #preview-container thead th:first-child {
            z-index: 3; /* 確保左上角在最上層 */
            left: 0;
        }
        
        /* --- 主要表格樣式 (保持不變) --- */
        #table-container table { border-collapse: collapse; width: 100%; margin-top: 1em; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06); border-radius: 8px; overflow: hidden; }
        #table-container th, #table-container td { border: 1px solid #e9ecef; padding: 14px 18px; text-align: left; vertical-align: middle; }
        #table-container thead { background-color: #007bff; color: white; }
        #table-container tbody tr:nth-child(even) { background-color: #f8f9fa; }
        #table-container tbody tr:hover { background-color: #e9ecef; }
        #table-container td:not(:first-child) { text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <h1>基金資料彙總報告產生器 (v3 - 帶預覽功能)</h1>
        
        <input type="file" id="file-input" multiple accept=".xlsx, .xls" style="display: none;">
        <div id="drop-zone">
            <p>拖曳 Excel 檔案至此</p>
            <span>或點擊此處選擇檔案</span>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>檢視模式：</label>
                    <div class="mode-selector">
                        <input type="radio" id="mode-individual" name="view-mode" value="individual" checked>
                        <label for="mode-individual">個別基金摘要</label>
                        <input type="radio" id="mode-sum" name="view-mode" value="sum">
                        <label for="mode-sum">所有基金加總</label>
                        <input type="radio" id="mode-compare" name="view-mode" value="compare">
                        <label for="mode-compare">單項比較</label>
                    </div>
                </div>
            </div>

            <div class="control-row">
                 <div class="control-group">
                    <button id="preview-btn" disabled>預覽第一個檔案</button>
                 </div>
                 <div class="control-group" style="flex-grow: 1;">
                    <label for="anchor-keyword-input">錨點關鍵字：</label>
                    <input type="text" id="anchor-keyword-input" value="項目" disabled>
                </div>
                 <div class="control-group" style="flex-grow: 1;">
                    <label for="range-input">資料範圍 (自動)：</label>
                    <input type="text" id="range-input" placeholder="處理時自動偵測" disabled>
                </div>
                 <button id="process-btn" disabled>開始處理</button>
            </div>
            <hr style="border: none; border-top: 1px solid #e0e0e0; width: 100%; margin: 0;">

            <div class="control-row">
                <div class="control-group" id="fund-select-group">
                    <label for="fund-select">選擇基金：</label>
                    <select id="fund-select" disabled></select>
                </div>
                <div class="control-group" id="item-select-group" style="display: none;">
                    <label for="item-select">選擇項目：</label>
                    <select id="item-select" disabled></select>
                </div>
                 <button id="download-html-btn" disabled>產生並下載HTML報告</button>
                 <button id="download-json-btn" disabled>匯出JSON檔</button>
            </div>
        </div>
        
        <div id="status"></div>
        
        <div id="preview-container"></div>
        
        <div id="table-container"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM 元素 ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const statusDiv = document.getElementById('status');
        const tableContainer = document.getElementById('table-container');

        // 控制項
        const previewBtn = document.getElementById('preview-btn'); // *** 新增 ***
        const anchorKeywordInput = document.getElementById('anchor-keyword-input');
        const rangeInput = document.getElementById('range-input');
        const processBtn = document.getElementById('process-btn');
        const modeRadios = document.querySelectorAll('input[name="view-mode"]');
        
        // 下拉選單
        const fundSelect = document.getElementById('fund-select');
        const itemSelect = document.getElementById('item-select');
        const fundSelectGroup = document.getElementById('fund-select-group');
        const itemSelectGroup = document.getElementById('item-select-group');
        
        // 匯出按鈕
        const downloadHtmlBtn = document.getElementById('download-html-btn');
        const downloadJsonBtn = document.getElementById('download-json-btn');
        
        // *** 新增 ***
        const previewContainer = document.getElementById('preview-container');

        // --- 全域變數 ---
        let allData = []; 
        let fundNames = [];
        let itemNames = [];
        let uploadedFiles = null; 
        
        let FIXED_HEADERS = [];
        let ROWS_PER_FILE = 0; 
        
        // --- 設定事件監聽 ---
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, preventDefaults, false));
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false));
        ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false));
        dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
        
        fundSelect.addEventListener('change', refreshTable);
        itemSelect.addEventListener('change', refreshTable);
        modeRadios.forEach(radio => radio.addEventListener('change', refreshTable));
        downloadHtmlBtn.addEventListener('click', generateAndDownloadHtml);
        downloadJsonBtn.addEventListener('click', generateAndDownloadJson);

        previewBtn.addEventListener('click', generatePreview); // *** 新增 ***
        processBtn.addEventListener('click', startProcessing);

        // --- 主要功能函式 ---

        /**
         * *** 修改點 (3) ***
         * `handleFiles` 現在只啟用 "預覽" 按鈕
         */
        function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            uploadedFiles = files;
            
            // 重置 UI
            resetUI(false); 
            previewContainer.innerHTML = ''; // 清除舊預覽
            statusDiv.textContent = `已選擇 ${files.length} 個檔案。請點擊預覽。`;
            
            // 啟用預覽按鈕
            previewBtn.disabled = false;
            anchorKeywordInput.disabled = true;
            processBtn.disabled = true;
        }

        /**
         * *** 新函式 (A) ***
         * 產生第一個檔案的預覽
         */
        async function generatePreview() {
            if (!uploadedFiles || uploadedFiles.length === 0) {
                alert("請先上傳檔案。");
                return;
            }

            previewBtn.disabled = true;
            statusDiv.textContent = "正在產生預覽...";
            previewContainer.innerHTML = ''; // 清空

            try {
                const firstFile = uploadedFiles[0];
                const workbook = await readFileAsWorkbook(firstFile);
                const firstSheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[firstSheetName];

                // 核心：將 sheet 轉為 2D 陣列
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });

                // 限制預覽的行列數，避免瀏覽器崩潰
                const maxRows = Math.min(rows.length, 100);
                const maxCols = Math.min(Math.max(...rows.map(r => r.length)), 26); // 最多到 Z 欄

                let html = '<table>';

                // 1. 建立標頭列 (A, B, C...)
                html += '<thead><tr><th></th>'; // 左上角空格
                for (let j = 0; j < maxCols; j++) {
                    html += '<th>' + XLSX.utils.encode_col(j) + '</th>';
                }
                html += '</tr></thead>';

                // 2. 建立資料列 (1, 2, 3...)
                html += '<tbody>';
                for (let i = 0; i < maxRows; i++) {
                    html += '<tr><th>' + (i + 1) + '</th>'; // 行號
                    const row = rows[i] || [];
                    for (let j = 0; j < maxCols; j++) {
                        const cellValue = row[j] != null ? row[j] : '';
                        html += '<td>' + escapeHTML(cellValue) + '</td>';
                    }
                    html += '</tr>';
                }
                html += '</tbody></table>';

                previewContainer.innerHTML = html;
                statusDiv.textContent = "預覽完成。請查看下方預覽，在上方輸入「錨點關鍵字」後點擊處理。";
                
                // 啟用下一步
                anchorKeywordInput.disabled = false;
                processBtn.disabled = false;

            } catch (err) {
                statusDiv.textContent = `產生預覽失敗：${err.message}`;
                previewBtn.disabled = false; // 允許重試
            }
        }
        
        // 輔助函式：防止 XSS
        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }


        /**
         * v2: `findDataRange` (保持不變)
         * @param {object} sheet - SheetJS 的工作表物件
         * @param {string} anchorKeyword - 用於搜尋標頭的關鍵字 (例如 "項目")
         */
        function findDataRange(sheet, anchorKeyword) {
            if (!anchorKeyword || anchorKeyword.trim() === "") {
                throw new Error("錨點關鍵Z不能為空。");
            }

            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });

            let headerRowIndex = -1;
            let startColIndex = -1;  

            // 1. 尋找標頭列
            for (let i = 0; i < rows.length; i++) {
                if (!rows[i]) continue;
                const colIndex = rows[i].findIndex(cell => 
                    cell != null && String(cell).trim() === anchorKeyword.trim()
                );
                
                if (colIndex !== -1) {
                    headerRowIndex = i;
                    startColIndex = colIndex;
                    break;
                }
            }

            if (headerRowIndex === -1) {
                throw new Error(`在工作表中找不到 '${anchorKeyword}' 標頭欄。`);
            }

            // 2. 取得完整的標頭陣列 (假設固定 9 欄)
            const headers = rows[headerRowIndex]
                .slice(startColIndex, startColIndex + 9)
                .map(h => h ? String(h).trim() : null);
            
            if (headers.length < 9 || headers.includes(null)) {
                 console.warn("偵測到的標頭不完整 (少於9欄或包含空值)", headers);
            }

            // 3. 尋找資料結束列
            let endDataRowIndex = headerRowIndex; 
            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row[startColIndex] == null || String(row[startColIndex]).trim() === "") {
                    break;
                }
                endDataRowIndex = i;
            }

            if (endDataRowIndex === headerRowIndex) {
                throw new Error(`在 '${anchorKeyword}' 標頭下找不到任何資料列。`);
            }

            // 4. 計算範圍
            const rowsPerFile = endDataRowIndex - headerRowIndex; 
            const startRow = headerRowIndex + 2; 
            const endRow = endDataRowIndex + 1;   
            
            const startColLetter = XLSX.utils.encode_col(startColIndex);
            const endColLetter = XLSX.utils.encode_col(startColIndex + 8);

            const rangeString = `${startColLetter}${startRow}:${endColLetter}${endRow}`;

            return {
                range: rangeString,
                headers: headers,
                rowsPerFile: rowsPerFile
            };
        }


        /**
         * v2: `startProcessing` (幾乎不變)
         */
        async function startProcessing() {
            if (!uploadedFiles || uploadedFiles.length === 0) {
                alert("沒有偵測到檔案。");
                return;
            }

            // 1. 取得使用者輸入的錨點
            const anchorKeyword = anchorKeywordInput.value;
            if (!anchorKeyword) {
                alert("請輸入錨點關鍵字 (例如：項目)。");
                return;
            }

            // 2. 重置 UI 並顯示讀取中
            resetUI(false); // 只重置表格
            statusDiv.textContent = `處理中... 正在使用 '${anchorKeyword}' 偵測範圍...`;
            processBtn.disabled = true;
            previewBtn.disabled = true; // 處理中不允許預覽

            let dataRange;

            try {
                // 3. 讀取第一個檔案以偵測範圍
                const firstFile = uploadedFiles[0];
                const workbook = await readFileAsWorkbook(firstFile);
                const firstSheetName = workbook.SheetNames[0];
                const mainSheet = workbook.Sheets[firstSheetName];

                // 4. 呼叫 findDataRange 並傳入關鍵字
                const result = findDataRange(mainSheet, anchorKeyword);
                
                // 5. 設定全域變數
                dataRange = result.range;
                FIXED_HEADERS = result.headers;
                ROWS_PER_FILE = result.rowsPerFile;

                // 6. 更新 UI 顯示偵測結果
                rangeInput.value = dataRange; // 填入自動偵測的範圍
                statusDiv.textContent = `範圍 ${dataRange} 偵測完成。正在處理 ${uploadedFiles.length} 個檔案...`;

            } catch (error) {
                // *** 修改點 (4) ***
                // 如果偵測失敗，顯示錯誤並停止，並重新啟用按鈕
                statusDiv.textContent = `錯誤：${error.message}`;
                console.error(error);
                processBtn.disabled = false; // 讓使用者可以重試
                previewBtn.disabled = false; // 讓使用者可以重試
                anchorKeywordInput.disabled = false;
                return;
            }

            // 7. 偵測成功，開始逐一處理所有檔案
            const filePromises = Array.from(uploadedFiles).map(file => processFile(file, dataRange));

            Promise.all(filePromises)
                .then(() => {
                    fundNames.sort();
                    itemNames.sort();
                    statusDiv.textContent = `處理完成！共 ${fundNames.length} 個基金。`;
                    populateDropdowns();
                    if (allData.length > 0) {
                        refreshTable();
                        downloadHtmlBtn.disabled = false;
                        downloadJsonBtn.disabled = false;
                    }
                    // 允許再次處理或預覽
                    processBtn.disabled = false; 
                    previewBtn.disabled = false;
                    anchorKeywordInput.disabled = false;
                })
                .catch(error => {
                    statusDiv.textContent = `處理檔案時發生錯誤：${error.message}`;
                    console.error(error);
                    processBtn.disabled = false;
                    previewBtn.disabled = false;
                    anchorKeywordInput.disabled = false;
                });
        }

        /**
         * v2: `readFileAsWorkbook` (不變)
         */
        function readFileAsWorkbook(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        resolve(workbook);
                    } catch (err) {
                        reject(new Error(`解析 ${file.name} 失敗: ${err.message}`));
                    }
                };
                reader.onerror = () => reject(new Error(`讀取 ${file.name} 失敗`));
                reader.readAsArrayBuffer(file);
            });
        }


        function resetUI(fullReset = true) {
            allData = [];
            fundNames = [];
            itemNames = [];
            [fundSelect, itemSelect, downloadHtmlBtn, downloadJsonBtn].forEach(el => el.disabled = true);
            tableContainer.innerHTML = '';
            
            if (fullReset) {
                uploadedFiles = null;
                rangeInput.value = '';
                processBtn.disabled = true;
                previewBtn.disabled = true;
                anchorKeywordInput.disabled = true;
                fileInput.value = ''; // 清除已選擇的檔案
                previewContainer.innerHTML = ''; // 清除預覽
            }
        }

        /**
         * v2: `processFile` (不變)
         */
        async function processFile(file, dataRange) {
            try {
                const workbook = await readFileAsWorkbook(file);
                const firstSheetName = workbook.SheetNames[0];
                const mainSheet = workbook.Sheets[firstSheetName];
                
                const fileNamePrefix = file.name.split('-')[0];
                let fundNameFromCell = XLSX.utils.sheet_to_json(mainSheet, { header: 1, defval: null })[1]?.[0] || `未知基金`;
                fundNameFromCell = fundNameFromCell.replace("基金名稱：", "").trim();
                const fundName = `${fileNamePrefix}-${fundNameFromCell}`;

                if (!fundNames.includes(fundName)) fundNames.push(fundName);

                const rows = XLSX.utils.sheet_to_json(mainSheet, { header: 1, range: dataRange, defval: null });

                const records = rows.map(rowArray => {
                    const record = { '基金名稱': fundName };
                    FIXED_HEADERS.forEach((header, index) => {
                        record[header] = rowArray[index];
                    });
                    const itemName = record[FIXED_HEADERS[0]]; // 第一欄 (錨點欄)
                    if (itemName && !itemNames.includes(itemName)) {
                        itemNames.push(itemName);
                    }
                    return record;
                });
                
                allData.push(...records);
            } catch (err) {
                throw new Error(`處理 ${file.name} 時失敗: ${err.message}`);
            }
        }
        
        // --- 後續函式 (populateDropdowns, refreshTable, display... , generate...) ---
        // --- 這些函式完全不需要修改 ---
        
        function populateDropdowns() {
            const populate = (selectEl, options) => {
                const currentVal = selectEl.value;
                selectEl.innerHTML = '';
                if (options.length === 0) {
                    selectEl.innerHTML = '<option>無可用選項</option>';
                    selectEl.disabled = true;
                    return;
                }
                options.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    selectEl.appendChild(option);
                });
                selectEl.value = currentVal;
                if(selectEl.selectedIndex === -1) selectEl.selectedIndex = 0;
                selectEl.disabled = false;
            };

            populate(fundSelect, fundNames);
            populate(itemSelect, itemNames);
        }

        function refreshTable() {
            const selectedMode = document.querySelector('input[name="view-mode"]:checked').value;
            if (allData.length === 0) return;

            fundSelectGroup.style.display = selectedMode === 'individual' ? 'flex' : 'none';
            itemSelectGroup.style.display = selectedMode === 'compare' ? 'flex' : 'none';
            
            tableContainer.innerHTML = '';
            switch (selectedMode) {
                case 'individual':
                    displayIndividualFundTable(fundSelect.value);
                    break;
                case 'sum':
                    displayAggregatedTable();
                    break;
                case 'compare':
                    displayItemComparisonTable(itemSelect.value);
                    break;
            }
        }

        function displayIndividualFundTable(fundName) {
            const records = allData.filter(r => r['基金名稱'] === fundName);
            if (!records || records.length === 0) {
                tableContainer.innerHTML = `<p>找不到基金「${fundName}」的資料。</p>`;
                return;
            }
            const table = createTable(FIXED_HEADERS);
            const tbody = table.querySelector('tbody');
            records.forEach(record => {
                const row = document.createElement('tr');
                FIXED_HEADERS.forEach(header => {
                    const cell = document.createElement('td');
                    cell.textContent = formatNumber(record[header]);
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
        }

        function displayAggregatedTable() {
            if (!allData || allData.length === 0) {
                tableContainer.innerHTML = `<p>沒有可加總的資料。</p>`;
                return;
            }
            
            const summaryData = [];
            for (let i = 0; i < ROWS_PER_FILE; i++) {
                const summaryRow = {};
                FIXED_HEADERS.forEach((header, headerIndex) => {
                    if (headerIndex === 0) {
                        summaryRow[header] = allData[i]?.[header];
                        return;
                    }
                    let sum = 0;
                    fundNames.forEach((fund, fundIndex) => {
                        const recordIndex = fundIndex * ROWS_PER_FILE + i;
                        const value = allData[recordIndex]?.[header];
                        if (typeof value === 'number' && !isNaN(value)) sum += value;
                    });
                    summaryRow[header] = sum;
                });
                summaryData.push(summaryRow);
            }

            const table = createTable(FIXED_HEADERS);
            const tbody = table.querySelector('tbody');
            summaryData.forEach(record => {
                const row = document.createElement('tr');
                FIXED_HEADERS.forEach(header => {
                    const cell = document.createElement('td');
                    cell.textContent = formatNumber(record[header]);
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
        }

        function displayItemComparisonTable(itemName) {
            if (!allData || allData.length === 0 || !itemName) {
                tableContainer.innerHTML = `<p>無法進行項目比較。</p>`;
                return;
            }
            const firstColumnHeader = FIXED_HEADERS[0];
            const comparisonHeaders = ['基金名稱', ...FIXED_HEADERS.slice(1)];
            const table = createTable(comparisonHeaders);
            const tbody = table.querySelector('tbody');

            fundNames.forEach(fund => {
                const itemRowData = allData.find(r => r['基金名稱'] === fund && r[firstColumnHeader] === itemName);
                const row = document.createElement('tr');
                
                let cell = document.createElement('td');
                cell.textContent = fund;
                row.appendChild(cell);

                comparisonHeaders.slice(1).forEach(header => {
                    cell = document.createElement('td');
                    const value = itemRowData ? itemRowData[header] : '-';
                    cell.textContent = formatNumber(value);
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
        }

        function createTable(headers) {
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const headerRow = document.createElement('tr');
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            table.appendChild(tbody);
            return table;
        }

        function formatNumber(value) {
            if (typeof value === 'number' && !isNaN(value)) {
                return Math.round(value).toLocaleString('en-US');
            }
            return value != null ? value : '';
        }
        
        function generateAndDownloadHtml() {
            // ... (此函式不變)
            const selectedMode = document.querySelector('input[name="view-mode"]:checked').value;
            let modeText = '';
            let subTitle = ``;

            switch (selectedMode) {
                case 'individual':
                    modeText = '個別基金摘要報告';
                    subTitle = `基金：${fundSelect.value}`;
                    break;
                case 'sum':
                    modeText = '所有基金加總報告';
                    break;
                case 'compare':
                    modeText = '單項比較報告';
                    subTitle = `比較項目：${itemSelect.value}`;
                    break;
            }
            
            const tableHtml = tableContainer.innerHTML;
            if (!tableHtml || tableHtml.startsWith('<p>')) {
                alert('沒有可匯出的資料！');
                return;
            }

            const styles = document.querySelector('style').innerHTML;
            const htmlContent = `
                <!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>${modeText}</title><style>${styles}</style></head>
                <body><div class="container"><h1>${modeText}</h1><h2>${subTitle}</h2>${tableHtml}</div></body></html>`;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const safeFilename = modeText.replace(/[\\/*?:"<>|]/g, '_');
            link.download = `${safeFilename}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function generateAndDownloadJson() {
            // ... (此函式不變)
            if (allData.length === 0) {
                alert('沒有可匯出的資料！');
                return;
            }
            
            const itemHeader = FIXED_HEADERS[0]; 
            const currentYearHeader = FIXED_HEADERS[8]; 
            const lastYearHeader = FIXED_HEADERS[2]; 
            const prevYearHeader = FIXED_HEADERS[1]; 

            if (!currentYearHeader || !lastYearHeader || !prevYearHeader) {
                alert("匯出 JSON 失敗：動態偵測的標頭不完整。");
                return;
            }

            const jsonData = allData.map(record => {
                const fullName = record['基金名稱'];
                const nameWithoutPrefix = fullName.substring(fullName.indexOf('-') + 1);

                return {
                    "基金名稱": nameWithoutPrefix,
                    "科目": record[itemHeader],
                    "本年度預算數": record[currentYearHeader],
                    "上年度預算數": record[lastYearHeader],
                    "前年度決算數": record[prevYearHeader]
                };
            });

            const jsonString = JSON.stringify(jsonData, null, 2);

            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `基金資料匯出_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }
    });
    </script>
</body>
</html>
