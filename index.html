<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金資料彙總報告產生器 (v16.1 - 分離版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="app-container">
        <div class="app-header">
            <h1>📊 基金資料彙總報告產生器</h1>
            <div class="version">v16.1 - 純淨版型模式</div>
        </div>
        
        <div class="progress-steps">
            <div class="step" id="step-1"><div class="step-number">1</div><div class="step-label">上傳檔案</div></div>
            <div class="step" id="step-2"><div class="step-number">2</div><div class="step-label">選擇版型</div></div>
            <div class="step" id="step-3"><div class="step-number">3</div><div class="step-label">確認欄位</div></div>
            <div class="step" id="step-4"><div class="step-number">4</div><div class="step-label">查看報告</div></div>
        </div>
        
        <div class="app-content">
            <div class="section" id="section-upload">
                <h2 class="section-title">上傳 Excel 檔案</h2>
                <div id="drop-area">
                    <input type="file" id="file-input" accept=".xlsx,.xls" multiple>
                    <div class="drop-text">拖曳多個 Excel 檔案至此</div>
                    <div class="drop-hint">或點擊選擇檔案 (支援 .xlsx, .xls)</div>
                </div>
                <div id="file-list-container"></div>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="clear-btn" class="btn btn-danger-outline" style="display: none;" data-icon="🗑️">清除所有檔案</button>
                </div>
            </div>
            
            <div class="section" id="section-preview" style="display:none;">
                <h2 class="section-title">版型選擇與設定</h2>
                
                <div class="form-row" style="margin-bottom: 20px; align-items: center;">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label">選擇報表版型 (僅帶入範圍設定)</label>
                        <select id="template-select" style="font-size: 1.1em; padding: 15px; border-color: #667eea; background-color: #f8f9ff;">
                            <option value="custom">🛠️ 自訂/通用模式 (手動設定)</option>
                            </select>
                    </div>
                </div>

                <div class="form-row template-actions" style="background: #f1f3f9; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                    <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 600; color: #555;">⚙️ 版面設定維護：</span>
                        <button class="btn btn-info" id="export-template-btn" data-icon="📤" style="padding: 8px 16px; font-size: 0.9em;">匯出設定 (JSON)</button>
                        <button class="btn btn-warning" id="import-template-btn" data-icon="📥" style="padding: 8px 16px; font-size: 0.9em;">匯入設定 (JSON)</button>
                        <input type="file" id="template-file-input" accept=".json" style="display: none;">
                    </div>
                </div>

                <div id="preview-area"><div class="empty-state">尚未載入檔案</div></div>
                
                <div class="form-row" style="margin-top:20px;">
                    <button class="btn btn-success" id="auto-detect-btn" data-icon="🔍">自動偵測範圍 (通用模式)</button>
                </div>
            </div>
            
            <div class="section" id="section-range" style="display:none;">
                <h2 class="section-title">確認資料範圍與來源設定</h2>
                <div id="detect-result"></div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">資料範圍 (含標頭)</label>
                        <input type="text" id="data-range-input" placeholder="例如: A5:G50">
                    </div>
                    <div class="form-group">
                        <label class="form-label">標頭佔用列數</label>
                        <input type="number" id="header-rows-input" value="1" min="1">
                    </div>
                </div>
                
                <div class="form-row" style="background: #f1f3f9; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                    <div class="form-group">
                        <label class="form-label">🏷️ 基金/來源名稱抓取方式</label>
                        <select id="source-name-mode">
                            <option value="filename">📂 使用檔案名稱 (預設)</option>
                            <option value="cell">📍 指定儲存格內容</option>
                        </select>
                    </div>
                    <div class="form-group" id="source-cell-group" style="display:none;">
                        <label class="form-label">來源名稱儲存格座標</label>
                        <input type="text" id="source-name-cell" placeholder="例如: B2, C3...">
                    </div>
                </div>

                <div class="form-row">
                    <button class="btn btn-primary" id="load-headers-btn" data-icon="📋">讀取欄位</button>
                </div>
            </div>
            
            <div class="section" id="section-mapping" style="display:none;">
                <h2 class="section-title">欄位設定與對應</h2>
                <div class="alert alert-info" id="mapping-alert">💡 請確認主鍵欄位 (項目/科目) 及要加總的數值欄位。</div>
                <div class="form-row" style="margin-bottom:20px;">
                    <button class="btn btn-success" id="transpose-btn" data-icon="🔄">欄列轉置</button>
                    <div class="form-group" id="transpose-controls" style="display:none;">
                        <label class="form-label">轉置後的主鍵欄位</label>
                        <select id="transpose-key-select" style="width:auto; min-width:200px;"></select>
                    </div>
                </div>
                <div id="mapping-fields"></div>
                <div class="form-row" style="margin-top:20px;">
                    <button class="btn btn-primary" id="process-btn" data-icon="⚡">開始彙總處理</button>
                </div>
            </div>
            
            <div class="output-section" id="output-area">
                <div id="validation-warnings" style="margin-bottom: 20px;"></div>
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
                    <h2 class="section-title" style="margin-bottom: 0;">彙總報告結果</h2>
                    <div class="export-controls">
                        <button class="btn btn-outline" id="export-json-btn" data-icon="💾">JSON</button>
                        <button class="btn btn-outline" id="export-csv-btn" data-icon="💾">CSV</button>
                        <button class="btn btn-outline" id="export-html-btn" data-icon="💾">HTML</button>
                        <button class="btn btn-outline" id="export-xlsx-btn" data-icon="💾">XLSX</button>
                    </div>
                </div>

                <div class="view-tabs">
                    <button class="tab-btn active" data-view="summary-view">📊 加總總表</button>
                    <button class="tab-btn" data-view="file-query-view">📁 檔案查詢</button>
                    <button class="tab-btn" data-view="item-view">🔍 項目查詢</button>
                </div>
                <div id="view-content">
                    <div id="summary-view" class="view-pane active"></div>
                    <div id="file-query-view" class="view-pane">
                        <select class="query-select" id="file-dropdown"></select>
                        <div id="file-detail-table"></div>
                    </div>
                    <div id="item-view" class="view-pane">
                        <select class="query-select" id="item-dropdown"></select>
                        <div id="item-detail-table"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="scripts.js"></script>
</body>
</html>
