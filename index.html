<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘è³‡æ–™å½™ç¸½å ±å‘Šç”¢ç”Ÿå™¨ (v10.2-final)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
            line-height: 1.6; background: #f4f7f6; color: #333; padding:20px; max-width:1400px; margin:0 auto;
        }
        h1,h2,h3{color:#0056b3;}
        h2{border-bottom:2px solid #e0e0e0; padding-bottom:5px;}
        #app-container{background:#fff;border-radius:8px;box-shadow:0 4px 12px #0001;padding:25px;}
        .config-section,.preview-section,.mapping-section,.output-section{margin-bottom:30px;}
        #drop-area{border:2px dashed #007bff;border-radius:8px;padding:40px;text-align:center;background:#f8faff;color:#0056b3;font-size:1.1em;cursor:pointer;transition:.3s;}
        #drop-area:hover{background:#e6f0ff;} #drop-area.minimized{padding:15px;font-size:.95em;}
        #file-input{display:none;} #file-list-display{list-style:none;padding:0;margin-top:10px;}
        #file-list-display li{font-size:.9em;color:#555;}
        #preview-area{max-height:400px;overflow:auto;border:1px solid #ddd;border-radius:5px;background:#fafafa;margin-top:15px;}
        #preview-area table,.report-table{width:100%;border-collapse:collapse;font-size:.9em;}
        #preview-area th,#preview-area td,.report-table th,.report-table td{border:1px solid #ccc;padding:6px 8px;min-width:80px;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        #preview-area thead th,.report-table thead th{position:-webkit-sticky;position:sticky;top:0;background:#e9ecef;z-index:10;}
        #preview-area tbody th,.report-table tbody th{position:-webkit-sticky;position:sticky;left:0;background:#f1f3f5;z-index:5;}
        #preview-area thead th:first-child,.report-table thead th:first-child{left:0;z-index:20;background:#e0e0e0;}
        .omitted-row-cell{text-align:center;color:#777;font-style:italic;background:#f9f9f9;}
        .report-table td.number{text-align:right;font-family:monospace;}
        .input-group{margin-top:15px;}
        .input-group label{display:block;font-weight:bold;margin-bottom:5px;color:#555;}
        .input-group input[type="text"],.input-group input[type="number"],.input-group select{width:100%;max-width:300px;padding:8px 10px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;}
        button{background:#007bff;color:#fff;border:none;padding:10px 18px;border-radius:5px;cursor:pointer;font-size:1em;font-weight:500;transition:.2s;margin-right:10px;}
        button:hover{background:#0056b3;}
        button:disabled{background:#c0c0c0;cursor:not-allowed;}
        #load-headers-btn{background:#28a745;} #load-headers-btn:hover{background:#218838;}
        #mapping-fields{display:none;padding-top:15px;}
        
        /* æ¬„ä½æ˜ å°„è¡¨æ ¼æ¨£å¼ */
        .mapping-table-container{margin-top:20px;overflow-x:auto;}
        .mapping-table{width:100%;border-collapse:collapse;background:#fff;}
        .mapping-table th{background:#007bff;color:#fff;padding:12px;text-align:left;font-weight:600;}
        .mapping-table td{padding:10px;border-bottom:1px solid #e0e0e0;}
        .mapping-table tr:hover{background:#f8f9fa;}
        .mapping-table input[type="text"]{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;}
        .mapping-table select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;background:#fff;}
        .mapping-table .col-excel{width:120px;font-family:monospace;color:#0056b3;font-weight:600;}
        .mapping-table .col-auto-header{max-width:200px;color:#666;font-size:0.9em;}
        .mapping-table .col-custom-name{min-width:200px;}
        .mapping-table .col-role{width:150px;}
        .mapping-table .col-include{width:80px;text-align:center;}
        .mapping-table input[type="checkbox"]{width:20px;height:20px;cursor:pointer;}
        
        .role-key{background:#ffc107;color:#000;padding:3px 8px;border-radius:3px;font-size:0.85em;font-weight:600;}
        .role-value{background:#28a745;color:#fff;padding:3px 8px;border-radius:3px;font-size:0.85em;font-weight:600;}
        .role-ignore{background:#6c757d;color:#fff;padding:3px 8px;border-radius:3px;font-size:0.85em;font-weight:600;}
        
        .hint-text{color:#666;font-size:0.9em;margin-top:10px;padding:10px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:4px;}
        
        .output-section{display:none;}
        .view-tabs{border-bottom:2px solid #dee2e6;margin-bottom:15px;}
        .tab-btn{background:transparent;color:#0056b3;border:none;padding:10px 15px;cursor:pointer;font-size:1.1em;margin-right:5px;border-radius:5px 5px 0 0;transition:.2s;}
        .tab-btn:hover{background:#e6f0ff;}
        .tab-btn.active{background:#0056b3;color:#fff;} .view-pane{display:none;padding:10px;}
        .view-pane.active{display:block;} #item-view select{font-size:1.1em;padding:8px;margin-bottom:15px;}
        #individual-view .individual-report{margin-bottom:30px;border-bottom:2px solid #0056b3;padding-bottom:15px;}
        
        .merge-hint{background:#fff3cd;border:2px dashed #ffc107;}
        .text-center{text-align:center;}
        .text-muted{color:#888;}
        
        #progress-container{height:22px;background:#e5e9f2;border-radius:8px;overflow:hidden;margin-bottom:8px;display:none;}
        #progress-bar{height:100%;background:#007bff;width:0%;transition:.25s;}
        #progress-text{margin-left:8px;}
        
        .auto-detect-info{background:#d1ecf1;border-left:4px solid #17a2b8;padding:10px;margin:10px 0;border-radius:4px;font-size:0.9em;}
        .auto-detect-info strong{color:#0c5460;}
    </style>
</head>
<body>
<div id="app-container">
    <h1>åŸºé‡‘è³‡æ–™å½™ç¸½å ±å‘Šç”¢ç”Ÿå™¨ (v10.2-final)</h1>
    
    <div class="config-section">
        <h2>1. ä¸Šå‚³å¤šå€‹æª”æ¡ˆ</h2>
        <div id="drop-area">æ‹–æ›³ <b>å¤šå€‹</b> Excel æª”æ¡ˆè‡³æ­¤ï¼Œæˆ–é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆ
            <input type="file" id="file-input" accept=".xlsx,.xls" multiple>
        </div>
        <ul id="file-list-display"></ul>
        <div id="progress-container"><div id="progress-bar"></div><span id="progress-text">0%</span></div>
    </div>
    
    <div class="preview-section">
        <h2>2. æª”æ¡ˆé è¦½ (ç¬¬ä¸€å€‹æª”æ¡ˆ)</h2>
        <div id="preview-area"><p style="padding:20px;text-align:center;color:#777;">å°šæœªè¼‰å…¥æª”æ¡ˆ</p></div>
    </div>
    
    <div class="config-section">
        <h2>3. è¨­å®šè³‡æ–™ç¯„åœ (å°‡å¥—ç”¨è‡³æ‰€æœ‰æª”æ¡ˆ)</h2>
        <div class="input-group">
            <label for="data-range">è³‡æ–™ç¯„åœ (å«æ¨™é ­åˆ—)</label>
            <input type="text" id="data-range" placeholder="ä¾‹å¦‚: A5:G50 (åŒ…å«æ¨™é ­é‚£ä¸€åˆ—)">
        </div>
        <div class="input-group">
            <button id="load-headers-btn" disabled>è‡ªå‹•åµæ¸¬ç¯„åœä¸¦è®€å–æ¬„ä½</button>
        </div>
        <div id="auto-detect-result"></div>
    </div>
    
    <div class="mapping-section">
        <h2>4. æ¬„ä½è¨­å®šèˆ‡å°æ‡‰</h2>
        <div class="hint-text">
            <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong><br>
            â€¢ <span class="role-key">ä¸»éµæ¬„ä½</span>ï¼šé¸æ“‡ä¸€å€‹æ¬„ä½ä½œç‚ºé …ç›®/ç§‘ç›®çš„è­˜åˆ¥æ¬„ä½ï¼ˆå¿…é ˆé¸æ“‡ä¸€å€‹ï¼‰<br>
            â€¢ <span class="role-value">åŠ ç¸½æ¬„ä½</span>ï¼šé¸æ“‡è¦åŠ ç¸½çš„æ•¸å€¼æ¬„ä½ï¼ˆå¯å¤šé¸ï¼‰<br>
            â€¢ <span class="role-ignore">å¿½ç•¥</span>ï¼šä¸ä½¿ç”¨æ­¤æ¬„ä½<br>
            â€¢ å¯ä»¥è‡ªè¨‚ã€Œå ±è¡¨æ¬„ä½åç¨±ã€ï¼Œè‹¥ä¸å¡«å¯«å‰‡ä½¿ç”¨ Excel æ¬„ä½åç¨±
        </div>
        <div id="mapping-fields"></div>
        <p id="mapping-placeholder" style="color:#777;">è«‹å…ˆè®€å–æ¬„ä½ä»¥é¡¯ç¤ºå°æ‡‰è¡¨æ ¼</p>
    </div>
    
    <div class="config-section">
        <button id="process-btn" disabled>é–‹å§‹å½™ç¸½è™•ç†</button>
    </div>
    
    <div class="output-section" id="output-area">
        <h2>5. å½™ç¸½å ±å‘Šçµæœ</h2>
        <div class="view-tabs">
            <button class="tab-btn active" data-view="summary-view">åŠ ç¸½ç¸½è¡¨</button>
            <button class="tab-btn" data-view="individual-view">å€‹åˆ¥æª”æ¡ˆ</button>
            <button class="tab-btn" data-view="item-view">é …ç›®æŸ¥è©¢</button>
        </div>
        <div id="view-content">
            <div id="summary-view" class="view-pane active"></div>
            <div id="individual-view" class="view-pane"></div>
            <div id="item-view" class="view-pane">
                <select id="item-dropdown"></select>
                <div id="item-detail-table"></div>
            </div>
        </div>
    </div>
</div>

<script>
const state = {
    workbooks:[], 
    allFileData:[], 
    summaryData:new Map(), 
    columnMappings:[],
};

// DOM Elements
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
const fileListDisplay = document.getElementById('file-list-display');
const progressContainer = document.getElementById('progress-container');
const progressBar = document.getElementById('progress-bar');
const progressText = document.getElementById('progress-text');
const previewArea = document.getElementById('preview-area');
const dataRangeInput = document.getElementById('data-range');
const loadHeadersBtn = document.getElementById('load-headers-btn');
const mappingFields = document.getElementById('mapping-fields');
const mappingPlaceholder = document.getElementById('mapping-placeholder');
const processBtn = document.getElementById('process-btn');
const outputArea = document.getElementById('output-area');
const itemDropdown = document.getElementById('item-dropdown');
const autoDetectResult = document.getElementById('auto-detect-result');

// --- Event Listeners Setup ---
dropArea.addEventListener('click', () => fileInput.click());
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, e => e.preventDefault());
});
['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.style.backgroundColor = '#e6f0ff');
});
['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.style.backgroundColor = '#f8faff');
});
dropArea.addEventListener('drop', e => {
    if(e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        handleFiles(fileInput.files);
    }
});
fileInput.addEventListener('change', e => {
    if(e.target.files.length > 0) {
        handleFiles(e.target.files);
    }
});
loadHeadersBtn.addEventListener('click', loadHeadersAndDetectRange);
processBtn.addEventListener('click', processData);
itemDropdown.addEventListener('change', renderItemDetailView);
// --- FIX: Add event listener to reset mappings when range is manually changed ---
dataRangeInput.addEventListener('input', resetMappings);

function resetMappings() {
    mappingFields.style.display = 'none';
    mappingPlaceholder.style.display = 'block';
    mappingFields.innerHTML = '';
    state.columnMappings = [];
    processBtn.disabled = true;
    autoDetectResult.innerHTML = '';
    outputArea.style.display = 'none';
}

function readFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const workbook = XLSX.read(e.target.result, {type: 'array'});
                resolve({file, workbook});
            } catch(err) {
                reject(err);
            }
        };
        reader.onerror = err => reject(err);
        reader.readAsArrayBuffer(file);
    });
}

async function handleFiles(fileList) {
    if([...fileList].some(f => f.size > 10 * 1024 * 1024)) {
        alert('æª”æ¡ˆéå¤§ (è¶…é10MB)ï¼Œè«‹åˆ†æ‰¹ä¸Šå‚³ï¼');
        return;
    }
    
    // --- UX: Reset everything when new files are uploaded ---
    resetMappings();
    dataRangeInput.value = '';
    
    dropArea.innerHTML = 'æ­£åœ¨è®€å–èˆ‡è§£ææª”æ¡ˆ...';
    previewArea.innerHTML = '<p style="padding:20px;text-align:center;">æ­£åœ¨è®€å–èˆ‡è§£ææª”æ¡ˆ...</p>';
    fileListDisplay.innerHTML = '';
    state.workbooks = [];
    progressContainer.style.display = "block";
    
    const filePromises = Array.from(fileList).map(file => readFile(file));
    
    try {
        const results = await Promise.all(filePromises.map((p, i) => p.then(res => {
            const pct = Math.round(((i + 1) / fileList.length) * 100);
            progressBar.style.width = pct + "%";
            progressText.textContent = pct + "%";
            return res;
        })));
        
        state.workbooks = results;
        fileListDisplay.innerHTML = 'å·²è¼‰å…¥æª”æ¡ˆï¼š' + state.workbooks.map(wb => `<li>- ${wb.file.name}</li>`).join('');
        dropArea.innerHTML = 'é»æ“Šæˆ–æ‹–æ›³æ›´æ›æª”æ¡ˆ';
        dropArea.classList.add('minimized');
        
        generatePreview(state.workbooks[0].workbook.Sheets[state.workbooks[0].workbook.SheetNames[0]]);
        loadHeadersBtn.disabled = false;
        
    } catch(err) {
        previewArea.innerHTML = `<p style="padding:20px;text-align:center;color:red;">æª”æ¡ˆè§£æå¤±æ•—ï¼š${err.message}</p>`;
        dropArea.classList.remove('minimized');
        dropArea.innerHTML = 'æ‹–æ›³ <b>å¤šå€‹</b> Excel æª”æ¡ˆè‡³æ­¤ï¼Œæˆ–é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆ';
    } finally {
        progressContainer.style.display = "none";
    }
}

function generatePreview(sheet) {
    if (!sheet || !sheet['!ref']) {
        previewArea.innerHTML = '<p class="text-center text-muted">å·¥ä½œè¡¨ç‚ºç©ºæˆ–ç„¡æ³•è®€å–</p>';
        return;
    }
    
    const range = XLSX.utils.decode_range(sheet['!ref']);
    const maxPreviewRows = 100;
    range.e.r = Math.min(range.e.r, range.s.r + maxPreviewRows);

    const data = XLSX.utils.sheet_to_json(sheet, { header: 1, range: range, defval: '' });
    
    let html = '<table><thead><tr><th></th>';
    for (let C = range.s.c; C <= range.e.c; ++C) {
        html += `<th>${XLSX.utils.encode_col(C)}</th>`;
    }
    html += '</tr></thead><tbody>';

    data.forEach((row, i) => {
        html += `<tr><th>${range.s.r + i + 1}</th>`;
        for (let j = 0; j <= (range.e.c - range.s.c); ++j) {
            html += `<td>${row[j] ?? ''}</td>`;
        }
        html += '</tr>';
    });

    if (XLSX.utils.decode_range(sheet['!ref']).e.r > range.e.r) {
        const colCount = range.e.c - range.s.c + 1;
        html += `<tr><th>...</th><td colspan="${colCount}" class="omitted-row-cell">... (åƒ…é¡¯ç¤ºå‰ ${maxPreviewRows} åˆ—) ...</td></tr>`;
    }

    html += '</tbody></table>';
    previewArea.innerHTML = html;
}

function autoDetectDataRange(sheet) {
    if (!sheet || !sheet['!ref']) return null;
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
    if (rows.length === 0) return null;

    let headerRowIdx = rows.findIndex(row => row.some(cell => cell != null && String(cell).trim() !== ''));
    if (headerRowIdx === -1) return null;

    let lastDataRowIdx = rows.length - 1;
    while (lastDataRowIdx > headerRowIdx && rows[lastDataRowIdx].every(cell => cell == null || String(cell).trim() === '')) {
        lastDataRowIdx--;
    }

    let firstCol = Infinity, lastCol = -1;
    for (let r = headerRowIdx; r <= lastDataRowIdx; r++) {
        rows[r].forEach((cell, c) => {
            if (cell != null && String(cell).trim() !== '') {
                if (c < firstCol) firstCol = c;
                if (c > lastCol) lastCol = c;
            }
        });
    }
    
    if (firstCol > lastCol) return null;

    return XLSX.utils.encode_range({
        s: { r: headerRowIdx, c: firstCol },
        e: { r: lastDataRowIdx, c: lastCol }
    });
}

function loadHeadersAndDetectRange() {
    if (state.workbooks.length === 0) return alert('è«‹å…ˆä¸Šå‚³æª”æ¡ˆ');
    
    const sheet = state.workbooks[0].workbook.Sheets[state.workbooks[0].workbook.SheetNames[0]];
    let rangeStr = dataRangeInput.value.trim().toUpperCase();
    
    if (!rangeStr) {
        rangeStr = autoDetectDataRange(sheet);
        if (rangeStr) {
            dataRangeInput.value = rangeStr;
            autoDetectResult.innerHTML = `<div class="auto-detect-info"><strong>âœ“ è‡ªå‹•åµæ¸¬æˆåŠŸ</strong><br>åµæ¸¬åˆ°è³‡æ–™ç¯„åœï¼š${rangeStr}</div>`;
        } else {
            return alert('ç„¡æ³•è‡ªå‹•åµæ¸¬ç¯„åœï¼Œè«‹æ‰‹å‹•è¼¸å…¥');
        }
    }
    
    try {
        const range = XLSX.utils.decode_range(rangeStr);
        const headerData = XLSX.utils.sheet_to_json(sheet, {
            header: 1,
            range: XLSX.utils.encode_range({ ...range, e: { ...range.e, r: range.s.r + 1 } }),
            defval: ''
        });
        
        const headerRow = headerData[0] || [];
        const sampleDataRow = headerData.length > 1 ? headerData[1] : [];
        
        state.columnMappings = [];
        for (let C = range.s.c; C <= range.e.c; ++C) {
            const colIdx = C - range.s.c;
            const excelCol = XLSX.utils.encode_col(C);
            const autoHeader = headerRow[colIdx] ? String(headerRow[colIdx]).trim() : '';
            const sampleValue = sampleDataRow[colIdx];
            
            let autoRole = 'ignore';
            if (autoHeader || sampleValue) {
                if (/ç§‘ç›®|é …ç›®|åç¨±|é¡åˆ¥|å“é …/.test(autoHeader)) {
                    autoRole = 'key';
                } else if (typeof sampleValue === 'number' || (sampleValue && !isNaN(parseFloat(String(sampleValue).replace(/,/g, ''))))) {
                    autoRole = 'value';
                }
            }
            
            state.columnMappings.push({ excelCol, autoHeader, customName: autoHeader, role: autoRole, include: autoRole !== 'ignore' });
        }
        
        renderMappingTable();
        mappingFields.style.display = 'block';
        mappingPlaceholder.style.display = 'none';
        processBtn.disabled = false;
        
    } catch(err) {
        alert(`è®€å–æ¬„ä½å¤±æ•—ï¼š${err.message}. \nè«‹æª¢æŸ¥è³‡æ–™ç¯„åœæ ¼å¼æ˜¯å¦æ­£ç¢º (ä¾‹å¦‚ A1:G50)`);
        resetMappings();
    }
}

function renderMappingTable() {
    let html = `<div class="mapping-table-container"><table class="mapping-table"><thead><tr><th>Excel æ¬„ä½</th><th>åŸå§‹æ¨™é ­</th><th>å ±è¡¨æ¬„ä½åç¨±</th><th>æ¬„ä½è§’è‰²</th><th>ä½¿ç”¨</th></tr></thead><tbody>`;
    
    state.columnMappings.forEach((col, idx) => {
        html += `
            <tr>
                <td class="col-excel">${col.excelCol}</td>
                <td class="col-auto-header">${col.autoHeader || '(ç©ºç™½)'}</td>
                <td class="col-custom-name"><input type="text" data-idx="${idx}" class="custom-name-input" value="${col.customName}" placeholder="è¼¸å…¥è‡ªè¨‚åç¨±"></td>
                <td class="col-role">
                    <select data-idx="${idx}" class="role-select">
                        <option value="ignore" ${col.role === 'ignore' ? 'selected' : ''}>å¿½ç•¥</option>
                        <option value="key" ${col.role === 'key' ? 'selected' : ''}>ä¸»éµæ¬„ä½</option>
                        <option value="value" ${col.role === 'value' ? 'selected' : ''}>åŠ ç¸½æ¬„ä½</option>
                    </select>
                </td>
                <td class="col-include"><input type="checkbox" data-idx="${idx}" class="include-checkbox" ${col.include ? 'checked' : ''}></td>
            </tr>
        `;
    });
    
    mappingFields.innerHTML = html + `</tbody></table></div>`;
    
    mappingFields.querySelectorAll('.custom-name-input').forEach(i => i.addEventListener('input', e => state.columnMappings[e.target.dataset.idx].customName = e.target.value.trim()));
    mappingFields.querySelectorAll('.include-checkbox').forEach(c => c.addEventListener('change', e => state.columnMappings[e.target.dataset.idx].include = e.target.checked));
    mappingFields.querySelectorAll('.role-select').forEach(s => s.addEventListener('change', e => {
        const idx = e.target.dataset.idx;
        state.columnMappings[idx].role = e.target.value;
        const isIgnored = e.target.value === 'ignore';
        state.columnMappings[idx].include = !isIgnored;
        mappingFields.querySelector(`.include-checkbox[data-idx="${idx}"]`).checked = !isIgnored;
    }));
}

function processData() {
    const keyColumns = state.columnMappings.filter(c => c.role === 'key' && c.include);
    const valueColumns = state.columnMappings.filter(c => c.role === 'value' && c.include);
    
    if (keyColumns.length !== 1) return alert('å¿…é ˆä¸”åªèƒ½é¸æ“‡ä¸€å€‹ä¸»éµæ¬„ä½ï¼');
    if (valueColumns.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åŠ ç¸½æ¬„ä½ï¼');
    
    const keyCol = keyColumns[0];
    const keyName = keyCol.customName || keyCol.autoHeader;
    const rangeStr = dataRangeInput.value.trim();
    if (!rangeStr) return alert('è«‹è¼¸å…¥è³‡æ–™ç¯„åœï¼');
    
    state.allFileData = [];
    state.summaryData = new Map();
    
    try {
        const range = XLSX.utils.decode_range(rangeStr);
        const headerRowIdx = range.s.r;
        
        state.workbooks.forEach(wb => {
            const sheet = wb.workbook.Sheets[wb.workbook.SheetNames[0]];
            if (!sheet || !sheet['!ref']) return;

            const sheetRange = XLSX.utils.decode_range(sheet['!ref']);
            const effectiveRange = {
                s: { r: headerRowIdx + 1, c: range.s.c },
                e: { r: Math.min(range.e.r, sheetRange.e.r), c: Math.min(range.e.c, sheetRange.e.c) }
            };
            if(effectiveRange.s.r > effectiveRange.e.r || effectiveRange.s.c > effectiveRange.e.c) return;
            
            const dataRows = XLSX.utils.sheet_to_json(sheet, { header: 1, range: effectiveRange, defval: null });
            
            const transformedData = dataRows.map(row => {
                if (!row || row.every(cell => cell == null || String(cell).trim() === '')) return null;
                
                const keyColIdx = XLSX.utils.decode_col(keyCol.excelCol) - range.s.c;
                const keyValue = row[keyColIdx];
                if (keyValue == null || String(keyValue).trim() === '') return null;
                
                const dataRow = { [keyName]: String(keyValue).trim() };
                valueColumns.forEach(valCol => {
                    const colIdx = XLSX.utils.decode_col(valCol.excelCol) - range.s.c;
                    const colName = valCol.customName || valCol.autoHeader;
                    dataRow[colName] = toNumber(row[colIdx]);
                });
                return dataRow;
            }).filter(Boolean); // Filter out null rows
            
            state.allFileData.push({ fileName: wb.file.name, data: transformedData });
        });
        
        state.allFileData.forEach(file => {
            file.data.forEach(row => {
                const key = row[keyName];
                let summaryRow = state.summaryData.get(key);
                if (!summaryRow) {
                    summaryRow = { [keyName]: key };
                    valueColumns.forEach(c => summaryRow[c.customName || c.autoHeader] = 0);
                    state.summaryData.set(key, summaryRow);
                }
                valueColumns.forEach(c => {
                    const colName = c.customName || c.autoHeader;
                    summaryRow[colName] += row[colName] || 0;
                });
            });
        });
        
        renderSummaryView(keyName, valueColumns);
        renderIndividualViews(keyName, valueColumns);
        renderItemView(keyName, valueColumns);
        
        outputArea.style.display = 'block';
        outputArea.scrollIntoView({ behavior: 'smooth' }); // UX improvement
        alert(`è™•ç†å®Œæˆï¼\nå…±è™•ç† ${state.workbooks.length} å€‹æª”æ¡ˆ\nå½™ç¸½äº† ${state.summaryData.size} å€‹é …ç›®`);
        
    } catch(err) {
        alert(`è™•ç†è³‡æ–™éŒ¯èª¤ï¼š${err.message}`);
        console.error(err);
    }
}

function toNumber(val) {
    if (val == null || val === '') return 0;
    if (typeof val === 'number') return val;
    const num = parseFloat(String(val).replace(/,/g, ''));
    return isNaN(num) ? 0 : num;
}

function generateHtmlTable(data, headers, formatNumbers = false) {
    let html = '<table class="report-table"><thead><tr>';
    headers.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';
    
    data.forEach(row => {
        html += '<tr>';
        headers.forEach(h => {
            const val = row[h];
            if (formatNumbers && typeof val === 'number') {
                html += `<td class="number">${val.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
            } else {
                html += `<td>${val != null ? val : ''}</td>`;
            }
        });
        html += '</tr>';
    });
    return html + '</tbody></table>';
}

function renderSummaryView(keyName, valueColumns) {
    const data = Array.from(state.summaryData.values());
    const headers = [keyName, ...valueColumns.map(c => c.customName || c.autoHeader)];
    document.getElementById('summary-view').innerHTML = '<h3>æ‰€æœ‰æª”æ¡ˆåŠ ç¸½çµæœ</h3>' + generateHtmlTable(data, headers, true);
}

function renderIndividualViews(keyName, valueColumns) {
    const headers = [keyName, ...valueColumns.map(c => c.customName || c.autoHeader)];
    let html = '';
    state.allFileData.forEach(file => {
        html += `<div class="individual-report"><h3>${file.fileName}</h3>${generateHtmlTable(file.data, headers, true)}</div>`;
    });
    document.getElementById('individual-view').innerHTML = html;
}

function renderItemView(keyName, valueColumns) {
    itemDropdown.innerHTML = '<option value="">--- è«‹é¸æ“‡è¦æŸ¥è©¢çš„é …ç›® ---</option>' 
        + Array.from(state.summaryData.keys()).sort().map(item => `<option value="${item}">${item}</option>`).join('');
    
    document.getElementById('item-detail-table').innerHTML = '';
    itemDropdown.dataset.keyName = keyName;
    itemDropdown.dataset.valueColumns = JSON.stringify(valueColumns.map(c => c.customName || c.autoHeader));
}

function renderItemDetailView() {
    const selectedItem = itemDropdown.value;
    const container = document.getElementById('item-detail-table');
    if (!selectedItem) return container.innerHTML = '';
    
    const keyName = itemDropdown.dataset.keyName;
    const valueColNames = JSON.parse(itemDropdown.dataset.valueColumns);
    const headers = ['æª”æ¡ˆåç¨±', ...valueColNames];
    
    const data = state.allFileData.map(file => {
        const row = file.data.find(r => r[keyName] === selectedItem);
        if (row && valueColNames.some(col => row[col] != 0)) {
            const dataRow = { 'æª”æ¡ˆåç¨±': file.fileName };
            valueColNames.forEach(colName => dataRow[colName] = row[colName] || 0);
            return dataRow;
        }
        return null;
    }).filter(Boolean);
    
    const summaryRow = state.summaryData.get(selectedItem);
    if (summaryRow) {
        const totalRow = { 'æª”æ¡ˆåç¨±': '<strong>ç¸½è¨ˆ</strong>' };
        valueColNames.forEach(colName => totalRow[colName] = summaryRow[colName] || 0);
        data.push(totalRow);
    }
    
    container.innerHTML = '<h3>é …ç›®ï¼š' + selectedItem + '</h3>' + generateHtmlTable(data, headers, true);
}

function setupTabs() {
    document.querySelector('.view-tabs').addEventListener('click', e => {
        if (e.target.classList.contains('tab-btn')) {
            const targetView = e.target.dataset.view;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === targetView));
            document.querySelectorAll('.view-pane').forEach(pane => pane.classList.toggle('active', pane.id === targetView));
        }
    });
}

// Initial page load setup
setupTabs();
</script>
</body>
</html>
