V<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘è³‡æ–™å½™ç¸½å ±å‘Šç”¢ç”Ÿå™¨ (v13.6)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background: #f4f7f9;
            padding: 20px;
        }
        
        #app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        .app-header h1 {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .app-header .version {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            padding: 30px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 0 10px;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #ddd;
            z-index: 0;
            transition: background 0.4s;
        }
        
        .step.active:not(:last-child)::after,
        .step.completed:not(:last-child)::after {
            background: #667eea;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: #999;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }
        
        .step.active .step-number {
            background: #667eea;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }
        
        .step.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .step-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }
        
        .step.active .step-label {
            color: #667eea;
            font-weight: 600;
        }
        
        .app-content { padding: 40px; }
        
        .section {
            margin-bottom: 40px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: inline-block;
        }
        
        #drop-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        #drop-area::before {
            content: 'ğŸ“';
            font-size: 4em;
            display: block;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        #drop-area:hover {
            background: linear-gradient(135deg, #e8ebff 0%, #dce0ff 100%);
            border-color: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        #drop-area.drag-over {
            background: linear-gradient(135deg, #d0d8ff 0%, #c0cbff 100%);
            border-color: #4050bf;
            transform: scale(1.02);
        }
        
        .drop-text { font-size: 1.2em; color: #667eea; font-weight: 600; margin-bottom: 10px; }
        .drop-hint { color: #888; font-size: 0.9em; }
        #file-input { display: none; }
        
        .file-list-details { margin-top: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0; transition: all 0.3s ease-in-out; }
        .file-list-summary { padding: 15px 20px; font-weight: 600; color: #667eea; cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; }
        .file-list-summary::-webkit-details-marker { display: none; }
        .file-list-summary::after { content: '+'; font-size: 1.8em; font-weight: bold; transition: transform 0.3s ease; line-height: 1; }
        .file-list-details[open] > .file-list-summary::after { content: 'âˆ’'; transform: rotate(180deg); }
        .file-list { padding: 0 20px 15px 20px; border-top: 1px solid #e0e0e0; }
        .file-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #e9ecef; }
        .file-item:last-child { border-bottom: none; }
        .file-item::before { content: 'ğŸ“„'; margin-right: 12px; font-size: 1.2em; }
        .file-item span { flex: 1; color: #555; font-size: 0.9em; }
        
        #preview-area { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; max-height: 450px; overflow: auto; }
        #preview-area table {
             /* <-- width: 100%; */
            border-collapse: collapse;
            background: white;
            font-size: 0.85em;
        }
        #preview-area th, #preview-area td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
        #preview-area thead th { background: #667eea; color: white; position: sticky; top: 0; z-index: 10; font-weight: 600; }
        
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-end; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        .form-label { display: block; font-weight: 600; color: #555; margin-bottom: 8px; font-size: 0.9em; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: all 0.3s; background: white; }
        input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); }
        .btn-success:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5); }
        .btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn::before { content: attr(data-icon); font-size: 1.2em; }
        
        .mapping-table-wrapper { background: #f8f9fa; border-radius: 8px; padding: 20px; overflow-x: auto; }
        .mapping-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .mapping-table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .mapping-table th { padding: 15px; text-align: left; font-weight: 600; font-size: 0.9em; }
        .mapping-table td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; }
        .mapping-table tr:hover { background: #f8f9ff; }
        .mapping-table input[type="text"], .mapping-table select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
        .mapping-table input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: #667eea; }
        .excel-col { font-family: 'Courier New', monospace; font-weight: 700; color: #667eea; font-size: 1.1em; }
        
        .output-section { display: none; animation: fadeIn 0.5s; }
        .view-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .tab-btn { padding: 12px 24px; border: none; background: transparent; color: #666; font-size: 1em; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; margin-bottom: -2px; }
        .tab-btn:hover { color: #667eea; background: #f8f9ff; }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; background: #f8f9ff; }
        
        .view-pane { display: none; animation: fadeIn 0.3s; }
        .view-pane.active { display: block; }
        
        .report-table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        .report-table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .report-table th { padding: 15px; text-align: left; font-weight: 600; }
        .report-table td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; }
        .report-table tbody tr:hover { background: #f8f9ff; }
        .report-table td.number { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; color: #667eea; }
        .report-table .total-row { background: #fff3cd !important; font-weight: 700; }
        .report-table .total-row td { border-top: 2px solid #ffc107; }
        
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .alert-info { background: #d1ecf1; border-left: 4px solid #17a2b8; color: #0c5460; }
        .alert-success { background: #d4edda; border-left: 4px solid #28a745; color: #155724; }
        /* ğŸ’¡ æ–°å¢ .alert-warning æ¨£å¼ */
        .alert-warning { background: #fff3cd; border-left: 4px solid #ffc107; color: #664d03; }
        
        .alert::before { content: 'â„¹ï¸'; font-size: 1.5em; }
        .alert-success::before { content: 'âœ…'; }
        .alert-warning::before { content: 'âš ï¸'; } /* ğŸ’¡ æ–°å¢ .alert-warning æ¨£å¼ */
        
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state::before { content: 'ğŸ“Š'; font-size: 4em; display: block; margin-bottom: 15px; opacity: 0.5; }
        
        .query-select { width: 100%; max-width: 500px; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1.1em; margin-bottom: 20px; background: white; cursor: pointer; }
        
        @media (max-width: 768px) {
            .app-content { padding: 20px; }
            .progress-steps { flex-wrap: wrap; }
            .step { flex-basis: 50%; margin-bottom: 20px; }
            .form-row { flex-direction: column; }
        }
    </style>
</head>

<body>
    <div id="app-container">
        <div class="app-header">
            <h1>ğŸ“Š åŸºé‡‘è³‡æ–™å½™ç¸½å ±å‘Šç”¢ç”Ÿå™¨</h1>
            <div class="version">v13.6 - çµæ§‹é©—è­‰</div>
        </div>
        
        <div class="progress-steps">
            <div class="step" id="step-1"><div class="step-number">1</div><div class="step-label">ä¸Šå‚³æª”æ¡ˆ</div></div>
            <div class="step" id="step-2"><div class="step-number">2</div><div class="step-label">åµæ¸¬ç¯„åœ</div></div>
            <div class="step" id="step-3"><div class="step-number">3</div><div class="step-label">è¨­å®šæ¬„ä½</div></div>
            <div class="step" id="step-4"><div class="step-number">4</div><div class="step-label">æŸ¥çœ‹å ±å‘Š</div></div>
        </div>
        
        <div class="app-content">
            <div class="section" id="section-upload">
                <h2 class="section-title">ä¸Šå‚³ Excel æª”æ¡ˆ</h2>
                <div id="drop-area">
                    <input type="file" id="file-input" accept=".xlsx,.xls" multiple>
                    <div class="drop-text">æ‹–æ›³å¤šå€‹ Excel æª”æ¡ˆè‡³æ­¤</div>
                    <div class="drop-hint">æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ (æ”¯æ´ .xlsx, .xls)</div>
                </div>
                <div id="file-list-container"></div>
            </div>
            
            <div class="section" id="section-preview" style="display:none;">
                <h2 class="section-title">æª”æ¡ˆé è¦½èˆ‡ç¯„åœåµæ¸¬</h2>
                <div id="preview-area"><div class="empty-state">å°šæœªè¼‰å…¥æª”æ¡ˆ</div></div>
                <div class="form-row" style="margin-top:20px;">
                    <button class="btn btn-success" id="auto-detect-btn" data-icon="ğŸ”">è‡ªå‹•åµæ¸¬ç¯„åœ</button>
                </div>
            </div>
            
            <div class="section" id="section-range" style="display:none;">
                <h2 class="section-title">ç¢ºèªè³‡æ–™ç¯„åœ</h2>
                <div id="detect-result"></div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">è³‡æ–™ç¯„åœ (å«æ¨™é ­)</label>
                        <input type="text" id="data-range-input" placeholder="ä¾‹å¦‚: A5:G50">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ¨™é ­ä½”ç”¨åˆ—æ•¸</label>
                        <input type="number" id="header-rows-input" value="1" min="1">
                    </div>
                    <button class="btn btn-primary" id="load-headers-btn" data-icon="ğŸ“‹">è®€å–æ¬„ä½</button>
                </div>
            </div>
            
            <div class="section" id="section-mapping" style="display:none;">
                <h2 class="section-title">æ¬„ä½è¨­å®šèˆ‡å°æ‡‰</h2>
                <div class="alert alert-info">ğŸ’¡ è«‹é¸æ“‡ä¸€å€‹<strong>ä¸»éµæ¬„ä½</strong>(é …ç›®/ç§‘ç›®),ä¸¦é¸æ“‡è¦<strong>åŠ ç¸½çš„æ•¸å€¼æ¬„ä½</strong>ã€‚</div>
                <div class="form-row" style="margin-bottom:20px;">
                    <button class="btn btn-success" id="transpose-btn" data-icon="ğŸ”„">æ¬„åˆ—è½‰ç½®</button>
                    <div class="form-group" id="transpose-controls" style="display:none;">
                        <label class="form-label">è½‰ç½®å¾Œçš„ä¸»éµæ¬„ä½</label>
                        <select id="transpose-key-select" style="width:auto; min-width:200px;"></select>
                    </div>
                </div>
                <div id="mapping-fields"></div>
                <div class="form-row" style="margin-top:20px;">
                    <button class="btn btn-primary" id="process-btn" data-icon="âš¡">é–‹å§‹å½™ç¸½è™•ç†</button>
                </div>
            </div>
            
            <div class="output-section" id="output-area">
                <div id="validation-warnings" style="margin-bottom: 20px;"></div>
                
                <h2 class="section-title">å½™ç¸½å ±å‘Šçµæœ</h2>
                <div class="view-tabs">
                    <button class="tab-btn active" data-view="summary-view">ğŸ“Š åŠ ç¸½ç¸½è¡¨</button>
                    <button class="tab-btn" data-view="file-query-view">ğŸ“ æª”æ¡ˆæŸ¥è©¢</button>
                    <button class="tab-btn" data-view="item-view">ğŸ” é …ç›®æŸ¥è©¢</button>
                </div>
                <div id="view-content">
                    <div id="summary-view" class="view-pane active"></div>
                    <div id="file-query-view" class="view-pane">
                        <select class="query-select" id="file-dropdown"></select>
                        <div id="file-detail-table"></div>
                    </div>
                    <div id="item-view" class="view-pane">
                        <select class="query-select" id="item-dropdown"></select>
                        <div id="item-detail-table"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const state = { 
            workbooks: [], 
            columnMappings: [], 
            allFileData: [], 
            summaryData: new Map(), 
            orderedItemKeys: [], 
            isTransposed: false, 
            originalData: null, 
            transposeKeyIndex: null 
        };
        
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const fileListContainer = document.getElementById('file-list-container');
        const previewArea = document.getElementById('preview-area');
        const mappingFields = document.getElementById('mapping-fields');
        const processBtn = document.getElementById('process-btn');
        const outputArea = document.getElementById('output-area');
        const itemDropdown = document.getElementById('item-dropdown');
        const autoDetectBtn = document.getElementById('auto-detect-btn');
        const dataRangeInput = document.getElementById('data-range-input');
        const headerRowsInput = document.getElementById('header-rows-input');
        const loadHeadersBtn = document.getElementById('load-headers-btn');
        const fileDropdown = document.getElementById('file-dropdown');
        const fileDetailTable = document.getElementById('file-detail-table');
        const detectResult = document.getElementById('detect-result');
        const transposeBtn = document.getElementById('transpose-btn');
        const transposeKeySelect = document.getElementById('transpose-key-select');
        const transposeControls = document.getElementById('transpose-controls');
        
        function updateStep(stepNum, status = 'active') {
            document.querySelectorAll('.step').forEach((step, i) => {
                step.classList.remove('active', 'completed');
                if (i + 1 < stepNum) step.classList.add('completed');
                if (i + 1 === stepNum) step.classList.add(status);
            });
        }
        
        dropArea.addEventListener('click', () => fileInput.click());
        ['dragenter', 'dragover'].forEach(e => dropArea.addEventListener(e, evt => {
            evt.preventDefault(); 
            dropArea.classList.add('drag-over');
        }));
        ['dragleave', 'drop'].forEach(e => dropArea.addEventListener(e, evt => {
            evt.preventDefault(); 
            dropArea.classList.remove('drag-over');
        }));
        dropArea.addEventListener('drop', e => { 
            if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); 
        });
        fileInput.addEventListener('change', e => { 
            if(e.target.files.length) handleFiles(e.target.files); 
        });
        autoDetectBtn.addEventListener('click', autoDetectBestRange);
        loadHeadersBtn.addEventListener('click', loadHeadersAndMapping);
        processBtn.addEventListener('click', processData);
        itemDropdown.addEventListener('change', renderItemDetailView);
        fileDropdown.addEventListener('change', renderFileDetailView);
        [dataRangeInput, headerRowsInput].forEach(input => input.addEventListener('input', resetMappings));
        transposeBtn.addEventListener('click', transposeData);
        transposeKeySelect.addEventListener('change', applyTranspose);
        
        function resetUI() {
            resetMappings();
            dataRangeInput.value = '';
            headerRowsInput.value = '1';
            detectResult.innerHTML = '';
            fileListContainer.innerHTML = '';
            document.getElementById('section-preview').style.display = 'none';
            document.getElementById('section-range').style.display = 'none';
            document.getElementById('section-mapping').style.display = 'none';
            updateStep(1);
        }
        
        function resetMappings() {
            document.getElementById('section-mapping').style.display = 'none';
            state.columnMappings = [];
            state.isTransposed = false;
            state.originalData = null;
            state.transposeKeyIndex = null;
            transposeControls.style.display = 'none';
            transposeBtn.textContent = 'ğŸ”„ æ¬„åˆ—è½‰ç½®';
            processBtn.disabled = true;
            outputArea.style.display = 'none';
        }
        
        async function handleFiles(fileList) {
            resetUI();
            previewArea.innerHTML = '<div class="empty-state">æ­£åœ¨è®€å–æª”æ¡ˆ...</div>';
            try {
                state.workbooks = await Promise.all(Array.from(fileList).map(readFile));
                const fileListHtml = `
                    <details class="file-list-details">
                        <summary class="file-list-summary">
                            âœ“ å·²è¼‰å…¥ ${state.workbooks.length} å€‹æª”æ¡ˆ (é»æ“ŠæŸ¥çœ‹æ¸…å–®)
                        </summary>
                        <div class="file-list">
                            ${state.workbooks.map(wb => 
                                `<div class="file-item"><span>${wb.file.name}</span></div>`
                            ).join('')}
                        </div>
                    </details>
                `;
                fileListContainer.innerHTML = fileListHtml;
                generatePreview(state.workbooks[0].workbook.Sheets[state.workbooks[0].workbook.SheetNames[0]]);
                document.getElementById('section-preview').style.display = 'block';
                updateStep(2);
            } catch(err) {
                previewArea.innerHTML = `<div class="empty-state" style="color:#dc3545;">æª”æ¡ˆè§£æå¤±æ•—ï¼š${err.message}</div>`;
            }
        }
        
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve({file, workbook: XLSX.read(e.target.result, {type: 'array'})});
                reader.onerror = err => reject(err);
                reader.readAsArrayBuffer(file);
            });
        }
        
        function generatePreview(sheet) {
            if (!sheet || !sheet['!ref']) {
                previewArea.innerHTML = '<div class="empty-state">å·¥ä½œè¡¨ç‚ºç©º</div>';
                return;
            }
            const range = XLSX.utils.decode_range(sheet['!ref']);
            range.e.r = Math.min(range.e.r, range.s.r + 100);
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1, range: range, defval: '' });
            let html = '<table><thead><tr><th></th>';
            for (let C = range.s.c; C <= range.e.c; ++C) html += `<th>${XLSX.utils.encode_col(C)}</th>`;
            html += '</tr></thead><tbody>';
            data.forEach((row, i) => {
                html += `<tr><th>${range.s.r + i + 1}</th>`;
                (row || []).forEach(cell => html += `<td>${cell ?? ''}</td>`);
                html += '</tr>';
            });
            previewArea.innerHTML = html + '</tbody></table>';
        }
        
        const isRowEmpty = (row) => !row || row.every(cell => cell == null || String(cell).trim() === '');
              function autoDetectBestRange() {
            if (state.workbooks.length === 0) return;
            resetMappings();
            const sheet = state.workbooks[0].workbook.Sheets[state.workbooks[0].workbook.SheetNames[0]];
            if (!sheet || !sheet['!ref']) {
                showDetectResult('å·¥ä½œè¡¨ç‚ºç©º', 'error');
                return;
            }
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
            if (rows.length === 0) {
                showDetectResult('å·¥ä½œè¡¨å…§æ²’æœ‰è³‡æ–™', 'error');
                return;
            }
            let headerRowIdx = -1;
            for (let i = 0; i < Math.min(rows.length, 30); i++) {
                if ((rows[i]?.filter(c => c != null && String(c).trim() !== '').length || 0) > 2) {
                    headerRowIdx = i;
                    break;
                }
            }
            if (headerRowIdx === -1) {
                showDetectResult('æ‰¾ä¸åˆ°æœ‰æ•ˆçš„æ¨™é ­åˆ—', 'error');
                return;
            }
            let lastDataRowIdx = headerRowIdx;
            for (let i = rows.length - 1; i > headerRowIdx; i--) {
                if (!isRowEmpty(rows[i])) {
                    lastDataRowIdx = i;
                    break;
                }
            }
            let firstCol = Infinity, lastCol = -1;
            for (let r = headerRowIdx; r <= lastDataRowIdx; r++) {
                if (!rows[r]) continue;
                rows[r].forEach((cell, c) => {
                    if (cell != null && String(cell).trim() !== '') {
                        firstCol = Math.min(firstCol, c);
                        lastCol = Math.max(lastCol, c);
                    }
                });
            }
            if (firstCol > lastCol) {
                showDetectResult('æ‰¾ä¸åˆ°æœ‰æ•ˆçš„è³‡æ–™æ¬„', 'error');
                return;
            }
            const detectedRange = { s: { r: headerRowIdx, c: firstCol }, e: { r: lastDataRowIdx, c: lastCol } };
            const rangeStr = XLSX.utils.encode_range(detectedRange);
            dataRangeInput.value = rangeStr;
            const blockRows = XLSX.utils.sheet_to_json(sheet, { header: 1, range: detectedRange, defval: null });
            let firstDataRowIndex = -1;
            for (let i = 1; i < blockRows.length; i++) {
                if (blockRows[i] && blockRows[i].slice(1).some(cell => cell != null && !isNaN(Number(cell)))) {
                    firstDataRowIndex = i;
                    break;
                }
            }
            const headerCount = (firstDataRowIndex > 0) ? firstDataRowIndex : 1;
            headerRowsInput.value = headerCount;
            showDetectResult(`æˆåŠŸåµæ¸¬åˆ°ç¯„åœï¼š${rangeStr}ï¼Œä¸¦é è¨­æ¨™é ­ä½” ${headerCount} åˆ—`, 'success');
            document.getElementById('section-range').style.display = 'block';
            updateStep(2, 'completed');
            updateStep(3);
        }
        
        function showDetectResult(message, type) {
            const className = type === 'success' ? 'alert-success' : 'alert-info';
            detectResult.innerHTML = `<div class="alert ${className}">${message}</div>`;
        }
        
        function unmergeAndFill(data, sheet, range) {
            (sheet['!merges'] || []).forEach(merge => {
                if (merge.s.c > range.e.c || merge.e.c < range.s.c || merge.s.r > range.e.r || merge.e.r < range.s.r) return;
                const s = { r: merge.s.r - range.s.r, c: merge.s.c - range.s.c };
                if (s.r < 0 || s.c < 0 || s.r >= data.length || !data[s.r]) return;
                const val = data[s.r][s.c];
                for (let r = s.r; r <= merge.e.r - range.s.r; r++) {
                    if (r >= data.length) break;
                    if (!data[r]) data[r] = [];
                    for (let c = s.c; c <= merge.e.c - range.s.c; c++) data[r][c] = val;
                }
            });
            return data;
        }
        
        function fillMergedCellsHorizontally(data, sheet, range) {
            // å…ˆè™•ç† Excel åŸç”Ÿçš„åˆä½µå„²å­˜æ ¼
            (sheet['!merges'] || []).forEach(merge => {
                if (merge.s.c > range.e.c || merge.e.c < range.s.c || merge.s.r > range.e.r || merge.e.r < range.s.r) return;
                const s = { r: merge.s.r - range.s.r, c: merge.s.c - range.s.c };
                if (s.r < 0 || s.c < 0 || s.r >= data.length || !data[s.r]) return;
                const val = data[s.r][s.c];
                for (let r = s.r; r <= merge.e.r - range.s.r; r++) {
                    if (r >= data.length) break;
                    if (!data[r]) data[r] = [];
                    for (let c = s.c; c <= merge.e.c - range.s.c; c++) data[r][c] = val;
                }
            });
            
            // é¡å¤–è£œå®Œï¼šå°æ–¼æ¯ä¸€åˆ—ï¼Œå°‡ç©ºç™½å„²å­˜æ ¼å¡«å…¥å·¦é‚Šæœ€è¿‘çš„éç©ºå€¼ï¼ˆæ°´å¹³å‘å³å¡«å……ï¼‰
            data.forEach((row, rowIdx) => {
                if (!row) return;
                let lastValue = null;
                for (let c = 0; c < row.length; c++) {
                    const cell = row[c];
                    if (cell != null && String(cell).trim() !== '') {
                        lastValue = cell;
                    } else if (lastValue != null) {
                        // å°‡ç©ºç™½å„²å­˜æ ¼å¡«å…¥å‰ä¸€å€‹éç©ºå€¼
                        row[c] = lastValue;
                    }
                }
            });
            
            return data;
        }
              function loadHeadersAndMapping() {
            const rangeStr = dataRangeInput.value.trim().toUpperCase();
            const headerRowCount = parseInt(headerRowsInput.value, 10);
            if (!rangeStr || isNaN(headerRowCount) || headerRowCount < 1) {
                return alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¯„åœå’Œæ¨™é ­åˆ—æ•¸');
            }
            try {
                const sheet = state.workbooks[0].workbook.Sheets[state.workbooks[0].workbook.SheetNames[0]];
                const range = XLSX.utils.decode_range(rangeStr);
                if (headerRowCount > (range.e.r - range.s.r + 1)) {
                    return alert("æ¨™é ­åˆ—æ•¸éå¤§ã€‚");
                }
                const headerBlockRange = { s: range.s, e: { c: range.e.c, r: range.s.r + headerRowCount - 1 } };
                let headerData = XLSX.utils.sheet_to_json(sheet, { header: 1, range: headerBlockRange, defval: null });
                headerData = unmergeAndFill(headerData, sheet, headerBlockRange);
                
                // ğŸ’¡ ä¿®æ­£é»ï¼šç§»é™¤æ‰€æœ‰ç©ºç™½
                const finalHeaders = Array.from({ length: range.e.c - range.s.c + 1 }, (_, c) => 
                    Array.from({ length: headerRowCount }, (_, r) => headerData[r]?.[c] || '')
                    .map(s => String(s).replace(/\s+/g, '')) // ç§»é™¤æ‰€æœ‰ç©ºç™½
                    .filter((v, i, a) => v && a.indexOf(v) === i)
                    .join('') // ä¸ä½¿ç”¨ç©ºç™½çµ„åˆ
                );
                
                // å„²å­˜åŸå§‹è³‡æ–™ä¾›è½‰ç½®ä½¿ç”¨
                const dataRange = { s: { r: range.s.r + headerRowCount, c: range.s.c }, e: range.e };
                let dataRows = XLSX.utils.sheet_to_json(sheet, { header: 1, range: dataRange, defval: null });
                dataRows = unmergeAndFill(dataRows, sheet, dataRange);
                state.originalData = { 
                    headers: finalHeaders, 
                    data: dataRows, 
                    range: range, 
                    headerRowCount: headerRowCount,
                    sheet: sheet
                };
                
                state.columnMappings = finalHeaders.map((header, i) => {
                    const excelCol = XLSX.utils.encode_col(range.s.c + i);
                    const autoRole = (i === 0) ? 'key' : (!header ? 'ignore' : 'value');
                    return { 
                        excelCol, 
                        autoHeader: header || `(ç©ºç™½æ¬„ ${excelCol})`, 
                        customName: header || '', 
                        role: autoRole, 
                        include: autoRole !== 'ignore' 
                    };
                });
                state.isTransposed = false;
                transposeControls.style.display = 'none';
                transposeBtn.textContent = 'ğŸ”„ æ¬„åˆ—è½‰ç½®';
                renderMappingTable();
                document.getElementById('section-mapping').style.display = 'block';
                updateStep(3, 'completed');
            } catch(err) {
                showDetectResult(`è®€å–æ¬„ä½å¤±æ•—ï¼š${err.message}`, 'error');
                resetMappings();
            }
        }
        
        function renderMappingTable() {
            let html = `<div class="mapping-table-wrapper"><table class="mapping-table">
                <thead><tr>
                    <th style="width:100px;">Excel æ¬„ä½</th>
                    <th>åŸå§‹æ¨™é ­</th>
                    <th>å ±è¡¨æ¬„ä½åç¨±</th>
                    <th style="width:150px;">æ¬„ä½è§’è‰²</th>
                    <th style="width:80px;">ä½¿ç”¨</th>
                </tr></thead><tbody>`;
            
            state.columnMappings.forEach((col, idx) => {
                html += `
                    <tr>
                        <td><span class="excel-col">${col.excelCol}</span></td>
                        <td>${col.autoHeader}</td>
                        <td><input type="text" data-idx="${idx}" class="custom-name-input" value="${col.customName}"></td>
                        <td>
                            <select data-idx="${idx}" class="role-select">
                                <option value="ignore" ${col.role === 'ignore' ? 'selected' : ''}>å¿½ç•¥</option>
                                <option value="key" ${col.role === 'key' ? 'selected' : ''}>ä¸»éµæ¬„ä½</option>
                                <option value="value" ${col.role === 'value' ? 'selected' : ''}>åŠ ç¸½æ¬„ä½</option>
                            </select>
                        </td>
                        <td style="text-align:center;">
                            <input type="checkbox" data-idx="${idx}" class="include-checkbox" ${col.include ? 'checked' : ''}>
                        </td>
                    </tr>`;
            });
            
            mappingFields.innerHTML = html + `</tbody></table></div>`;
            
            mappingFields.querySelectorAll('.custom-name-input').forEach(i => 
                i.addEventListener('input', e => state.columnMappings[e.target.dataset.idx].customName = e.target.value.trim())
            );
            mappingFields.querySelectorAll('.include-checkbox').forEach(c => 
                c.addEventListener('change', e => state.columnMappings[e.target.dataset.idx].include = e.target.checked)
            );
            mappingFields.querySelectorAll('.role-select').forEach(s => 
                s.addEventListener('change', e => {
                    const idx = e.target.dataset.idx;
                    const isIgnored = e.target.value === 'ignore';
                    state.columnMappings[idx].role = e.target.value;
                    state.columnMappings[idx].include = !isIgnored;
                    mappingFields.querySelector(`.include-checkbox[data-idx="${idx}"]`).checked = !isIgnored;
                })
            );
            processBtn.disabled = false;
        }
              function transposeData() {
            if (!state.originalData) {
                alert('è«‹å…ˆè®€å–æ¬„ä½è³‡æ–™');
                return;
            }
            
            if (state.isTransposed) {
                // é‚„åŸåˆ°åŸå§‹ç‹€æ…‹ (é€™éƒ¨åˆ†ä¸éœ€è¦è®Šæ›´ï¼Œå› ç‚ºå®ƒåªæ˜¯é‚„åŸ)
                const { headers } = state.originalData;
                state.columnMappings = headers.map((header, i) => {
                    const excelCol = XLSX.utils.encode_col(state.originalData.range.s.c + i);
                    const autoRole = (i === 0) ? 'key' : (!header ? 'ignore' : 'value');
                    return { 
                        excelCol, 
                        autoHeader: header || `(ç©ºç™½æ¬„ ${excelCol})`, 
                        customName: header || '', 
                        role: autoRole, 
                        include: autoRole !== 'ignore' 
                    };
                });
                state.isTransposed = false;
                transposeControls.style.display = 'none';
                transposeBtn.textContent = 'ğŸ”„ æ¬„åˆ—è½‰ç½®';
                renderMappingTable();
            } else {
                // åŸ·è¡Œè½‰ç½®å‰å…ˆè£œå®Œæ¨™é¡Œåˆ—
                const { headers, data, range, headerRowCount, sheet } = state.originalData;
                
                // é‡æ–°è®€å–æ¨™é¡Œå€åŸŸï¼ŒåŒ…å«åˆä½µå„²å­˜æ ¼è³‡è¨Š
                const headerBlockRange = { s: range.s, e: { c: range.e.c, r: range.s.r + headerRowCount - 1 } };
                let headerData = XLSX.utils.sheet_to_json(sheet, { header: 1, range: headerBlockRange, defval: null });
                
                // è£œå®Œåˆä½µå„²å­˜æ ¼ï¼ˆæ°´å¹³æ–¹å‘ï¼‰
                headerData = fillMergedCellsHorizontally(headerData, sheet, headerBlockRange);
                
                // ğŸ’¡ ä¿®æ­£é»ï¼šç§»é™¤æ‰€æœ‰ç©ºç™½
                const completeHeaders = Array.from({ length: range.e.c - range.s.c + 1 }, (_, c) => 
                    Array.from({ length: headerRowCount }, (_, r) => headerData[r]?.[c] || '')
                    .map(s => String(s).replace(/\s+/g, '')) // ç§»é™¤æ‰€æœ‰ç©ºç™½
                    .filter((v, i, a) => v && a.indexOf(v) === i)
                    .join('') // ä¸ä½¿ç”¨ç©ºç™½çµ„åˆ
                );
                
                // æ›´æ–°åŸå§‹è³‡æ–™ä¸­çš„æ¨™é¡Œ
                state.originalData.headers = completeHeaders;
                
                // å»ºç«‹ä¸‹æ‹‰é¸å–®é¸é …
                transposeKeySelect.innerHTML = '<option value="">--- è«‹é¸æ“‡ä¸»éµæ¬„ä½ ---</option>' + 
                    completeHeaders.map((h, i) => `<option value="${i}">${h || `æ¬„ä½ ${i+1}`}</option>`).join('');
                
                transposeControls.style.display = 'flex';
                transposeBtn.textContent = 'â†©ï¸ é‚„åŸæ¬„åˆ—';
                alert('âœ… æ¨™é¡Œåˆ—å·²è£œå®Œï¼\n\nè«‹é¸æ“‡ä¸€å€‹æ¬„ä½ä½œç‚ºè½‰ç½®å¾Œçš„ä¸»éµ');
            }
        }
        
        function applyTranspose() {
            const keyColIndex = parseInt(transposeKeySelect.value);
            if (isNaN(keyColIndex)) return;
            
            const { headers, data } = state.originalData;
            
            // éæ¿¾æ‰ç©ºç™½è¡Œ
            const validData = data.filter(row => !isRowEmpty(row));
            
            // å»ºç«‹è½‰ç½®å¾Œçš„è³‡æ–™
            const transposedMappings = [];
            
            // ğŸ’¡ ä¿®æ­£é»ï¼šä½¿ç”¨ isFirstMapping è®Šæ•¸
            let isFirstMapping = true;

            headers.forEach((originalHeader, colIdx) => {
                if (colIdx === keyColIndex) return; // è·³éä¸»éµæ¬„ä½
                
                const rowName = originalHeader || `æ¬„ä½ ${colIdx + 1}`;
                
                // åˆ¤æ–·ç•¶å‰çš„è§’è‰²
                let currentRole = 'value'; // é è¨­ç‚º 'value'
                if (isFirstMapping) {
                    currentRole = 'key'; // è½‰ç½®å¾Œçš„ç¬¬ä¸€å€‹æ¬„ä½æ‰æ˜¯ 'key'
                    isFirstMapping = false; // ä¹‹å¾Œçš„æ¬„ä½éƒ½æ˜¯ 'value'
                }

                transposedMappings.push({
                    excelCol: XLSX.utils.encode_col(state.originalData.range.s.c + colIdx),
                    autoHeader: rowName,
                    customName: rowName,
                    role: currentRole, // ğŸ’¡ ä¿®æ­£é»ï¼šä½¿ç”¨ä¿®æ­£å¾Œçš„ role
                    include: true,
                    isTransposeHeader: true
                });
            });
            
            state.columnMappings = transposedMappings;
            state.isTransposed = true;
            state.transposeKeyIndex = keyColIndex;
            
            renderMappingTable();
            alert(`âœ… è½‰ç½®å®Œæˆ!\næ–°çš„ä¸»éµæ¬„ä½: ${headers[keyColIndex] || `æ¬„ä½ ${keyColIndex + 1}`}\nå…±ç”¢ç”Ÿ ${validData.length} å€‹æ•¸å€¼æ¬„ä½`);
        }
        
        // ğŸ’¡ æ­¥é©Ÿ 2ï¼šæ›¿æ›ç‚ºåŒ…å«é©—è­‰é‚è¼¯çš„ processData
        function processData() {
            const keyColumns = state.columnMappings.filter(c => c.role === 'key' && c.include);
            const valueColumns = state.columnMappings.filter(c => c.role === 'value' && c.include);
            if (keyColumns.length !== 1) return alert('âš ï¸ å¿…é ˆé¸æ“‡ä¸€å€‹ä¸»éµæ¬„ä½ï¼');
            if (valueColumns.length === 0) return alert('âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åŠ ç¸½æ¬„ä½ï¼');
            
            const keyCol = keyColumns[0];
            const keyName = keyCol.customName || keyCol.autoHeader;
            const rangeStr = dataRangeInput.value.trim();
            if (!rangeStr) return alert('âš ï¸ è«‹è¼¸å…¥è³‡æ–™ç¯„åœï¼');
            
            const excludedFiles = [];
            const templateHeaders = state.originalData.headers; // åŸºæº–æ¨™é ­ (å·²å»é™¤ç©ºç™½)
            const headerRowCount = parseInt(headerRowsInput.value, 10);
            const warningContainer = document.getElementById('validation-warnings');
            warningContainer.innerHTML = ''; 
            
            state.allFileData = [];
            state.summaryData = new Map();
            state.orderedItemKeys = [];
            
            try {
                const range = XLSX.utils.decode_range(rangeStr);
                const dataRange = { 
                    s: { r: range.s.r + headerRowCount, c: range.s.c }, 
                    e: range.e 
                };
                
                state.workbooks.forEach(wb => {
                    const sheet = wb.workbook.Sheets[wb.workbook.SheetNames[0]];
                    
                    // --- é©—è­‰é‚è¼¯é–‹å§‹ ---
                    let isIdentical = false;
                    if (wb.file.name === state.workbooks[0].file.name) {
                        isIdentical = true;
                    } else if (sheet && sheet['!ref']) {
                        try {
                            const headerBlockRange = { s: range.s, e: { c: range.e.c, r: range.s.r + headerRowCount - 1 } };
                            let currentHeaderData = XLSX.utils.sheet_to_json(sheet, { header: 1, range: headerBlockRange, defval: null });
                            currentHeaderData = unmergeAndFill(currentHeaderData, sheet, headerBlockRange);
                            
                            // ğŸ’¡ ä¿®æ­£é»ï¼šç§»é™¤æ‰€æœ‰ç©ºç™½
                            const currentFinalHeaders = Array.from({ length: range.e.c - range.s.c + 1 }, (_, c) => 
                                Array.from({ length: headerRowCount }, (_, r) => currentHeaderData[r]?.[c] || '')
                                .map(s => String(s).replace(/\s+/g, '')) // ç§»é™¤æ‰€æœ‰ç©ºç™½
                                .filter((v, i, a) => v && a.indexOf(v) === i)
                                .join('') // ä¸ä½¿ç”¨ç©ºç™½çµ„åˆ
                            );
                            
                            // 2. æ¯”å°æ¨™é ­
                            if (currentFinalHeaders.length === templateHeaders.length && 
                                currentFinalHeaders.every((h, i) => h === templateHeaders[i])) {
                                isIdentical = true;
                            }
                        } catch (err) {
                            console.error(`Error validating file ${wb.file.name}:`, err);
                            isIdentical = false; 
                        }
                    }
                    
                    if (!isIdentical) {
                        if (wb.file.name !== state.workbooks[0].file.name) {
                            excludedFiles.push(wb.file.name);
                        }
                        return; 
                    }
                    // --- é©—è­‰é‚è¼¯çµæŸ ---
                    
                    if (!sheet || !sheet['!ref']) return; 

                    let dataRows = XLSX.utils.sheet_to_json(sheet, { header: 1, range: dataRange, defval: null });
                    dataRows = unmergeAndFill(dataRows, sheet, dataRange);
                    
                    let transformedData;
                    
                    if (state.isTransposed) {
                        // è½‰ç½®æ¨¡å¼è™•ç†
                        const { headers } = state.originalData;
                        const keyColIndex = state.transposeKeyIndex;
                        const validData = dataRows.filter(row => !isRowEmpty(row));
                        
                        transformedData = [];
                        state.columnMappings.forEach(mapping => {
                            const colIdx = XLSX.utils.decode_col(mapping.excelCol) - range.s.c;
                            if (colIdx === keyColIndex) return; 
                            
                            const dataRow = { [keyName]: mapping.customName || mapping.autoHeader };
                            validData.forEach((row, rowIdx) => {
                                // ğŸ’¡ è½‰ç½®æ¨¡å¼çš„ "æ–°æ¨™é ­" ä¹Ÿæ‡‰ç§»é™¤ç©ºç™½
                                const colHeader = String(row[keyColIndex] || '').replace(/\s+/g, '');
                                if (colHeader) {
                                    dataRow[colHeader] = toNumber(row[colIdx]);
                                }
                            });
                            transformedData.push(dataRow);
                        });
                    } else {
                        // æ­£å¸¸æ¨¡å¼è™•ç†
                        const keyColIndex = XLSX.utils.decode_col(keyCol.excelCol) - range.s.c;
                        transformedData = dataRows.map(row => {
                            if (isRowEmpty(row)) return null;
                            const keyValue = row[keyColIndex];
                            if (keyValue == null || String(keyValue).trim() === '') return null;
                            
                            // ğŸ’¡ ä¸»éµå€¼ä¹Ÿæ‡‰ç§»é™¤æ‰€æœ‰ç©ºç™½
                            const dataRow = { [keyName]: String(keyValue).replace(/\s+/g, '') };
                            valueColumns.forEach(valCol => {
                                const colIdx = XLSX.utils.decode_col(valCol.excelCol) - range.s.c;
                                dataRow[valCol.customName || valCol.autoHeader] = toNumber(row[colIdx]);
                            });
                            return dataRow;
                        }).filter(Boolean);
                    }
                    
                    state.allFileData.push({ fileName: wb.file.name, data: transformedData });
                });
                
                // æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„ä¸»éµå€¼ï¼Œä¿æŒé †åº
                const seenKeys = new Set();
                state.allFileData.forEach(file => {
                    file.data.forEach(row => {
                        const key = row[keyName];
                        if (!seenKeys.has(key)) {
                            seenKeys.add(key);
                            state.orderedItemKeys.push(key);
                        }
                    });
                });
                
                // å–å¾—æ‰€æœ‰æ•¸å€¼æ¬„ä½åç¨±
                const allValueColumns = state.isTransposed 
                    ? Object.keys(state.allFileData[0]?.data[0] || {}).filter(k => k !== keyName)
                    : valueColumns.map(c => c.customName || c.autoHeader);
                
                // å½™ç¸½è³‡æ–™
                state.allFileData.forEach(file => {
                    file.data.forEach(row => {
                        const key = row[keyName];
                        let summaryRow = state.summaryData.get(key) || { 
                            [keyName]: key, 
                            ...Object.fromEntries(allValueColumns.map(c => [c, 0])) 
                        };
                        allValueColumns.forEach(c => {
                            summaryRow[c] += row[c] || 0;
                        });
                        state.summaryData.set(key, summaryRow);
                    });
                });

                state.exportKeyName = keyName;
                state.exportValueColumns = allValueColumns;
                
                if (excludedFiles.length > 0) {
                    warningContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>${excludedFiles.length} å€‹æª”æ¡ˆæœªç´å…¥å½™ç¸½</strong>
                            <p style="margin-top:10px; font-size: 0.9em;">
                                åµæ¸¬åˆ°ä»¥ä¸‹æª”æ¡ˆçš„è³‡æ–™ç¯„åœæˆ–æ¨™é ­çµæ§‹èˆ‡ç¬¬ä¸€å€‹æª”æ¡ˆä¸ç¬¦ï¼Œå·²è‡ªå‹•ç•¥éï¼š
                            </p>
                            <ul style="padding-left: 20px; font-size: 0.9em;">
                                ${excludedFiles.map(name => `<li>${name}</li>`).join('')}
                            </ul>
                        </div>`;
                }
                
                renderSummaryView(keyName, allValueColumns);
                renderFileQueryView(keyName, allValueColumns);
                renderItemView(keyName, allValueColumns);
                outputArea.style.display = 'block';
                updateStep(4, 'completed');
                outputArea.scrollIntoView({ behavior: 'smooth' });
                
                const processedFileCount = state.workbooks.length - excludedFiles.length;
                alert(`âœ… è™•ç†å®Œæˆï¼\n\nå…± ${processedFileCount} å€‹æª”æ¡ˆæˆåŠŸç´å…¥å½™ç¸½\n${excludedFiles.length} å€‹æª”æ¡ˆå› çµæ§‹ä¸ç¬¦è¢«ç•¥é\nå½™ç¸½äº† ${state.summaryData.size} å€‹é …ç›®`);
            
            } catch(err) {
                alert(`âŒ è™•ç†è³‡æ–™éŒ¯èª¤ï¼š${err.message}`);
                console.error(err);
            }
        }

        
        function toNumber(val) {
            if (val == null || val === '') return 0;
            if (typeof val === 'number') return val;
            return parseFloat(String(val).replace(/,/g, '')) || 0;
        }
              function generateHtmlTable(data, headers, formatNumbers = false, firstRowClass = '') {
            let html = '<table class="report-table"><thead><tr>' + 
                headers.map(h => `<th>${h}</th>`).join('') + 
                '</tr></thead><tbody>';
            
            data.forEach((row, index) => {
                const rowClass = (index === 0 && firstRowClass) ? ` class="${firstRowClass}"` : '';
                html += `<tr${rowClass}>` + headers.map(h => {
                    const val = row[h];
                    if (formatNumbers && h !== 'æª”æ¡ˆåç¨±' && typeof val === 'number') {
                        return `<td class="number">${val.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>`;
                    }
                    return `<td>${val ?? ''}</td>`;
                }).join('') + '</tr>';
            });
            
            return html + '</tbody></table>';
        }
        
        function renderSummaryView(keyName, valueColumns) {
            const valueColNames = Array.isArray(valueColumns) ? valueColumns : valueColumns.map(c => c.customName || c.autoHeader);
            const headers = [keyName, ...valueColNames];
            const data = Array.from(state.summaryData.values());
            document.getElementById('summary-view').innerHTML = 
                `<h3 style="margin-bottom:20px; color:#667eea;">ğŸ“Š æ‰€æœ‰æª”æ¡ˆåŠ ç¸½çµæœ (å…± ${data.length} é …)</h3>` + 
                generateHtmlTable(data, headers, true);
        }
        
        function renderFileQueryView(keyName, valueColumns) {
            const valueColNames = Array.isArray(valueColumns) ? valueColumns : valueColumns.map(c => c.customName || c.autoHeader);
            fileDropdown.innerHTML = '<option value="">--- è«‹é¸æ“‡è¦æŸ¥è©¢çš„æª”æ¡ˆ ---</option>' + 
                state.workbooks.map(wb => `<option value="${wb.file.name}">${wb.file.name}</option>`).join('');
            fileDetailTable.innerHTML = '';
            fileDropdown.dataset.keyName = keyName;
            fileDropdown.dataset.valueColumns = JSON.stringify(valueColNames);
        }
        
        function renderFileDetailView() {
            const selectedFilename = fileDropdown.value;
            const container = fileDetailTable;
            if (!selectedFilename) {
                container.innerHTML = '';
                return;
            }
            
            const keyName = fileDropdown.dataset.keyName;
            const valueColNames = JSON.parse(fileDropdown.dataset.valueColumns);
            const headers = [keyName, ...valueColNames];
            const fileData = state.allFileData.find(file => file.fileName === selectedFilename);
            
            if (!fileData) {
                // ğŸ’¡ å¦‚æœæª”æ¡ˆè¢«æ’é™¤äº†ï¼Œé¡¯ç¤ºé€™å€‹è¨Šæ¯
                container.innerHTML = `<div class="empty-state" style="color:#664d03;">æ­¤æª”æ¡ˆå¯èƒ½å› çµæ§‹ä¸ç¬¦ï¼Œæœªè¢«ç´å…¥å½™ç¸½ã€‚<br/>(åœ¨ "åŠ ç¸½ç¸½è¡¨" é ç±¤é ‚ç«¯å¯æŸ¥çœ‹è©³æƒ…)</div>`;
                return;
            }
            
            container.innerHTML = 
                `<h3 style="margin-bottom:20px; color:#667eea;">ğŸ“ ${selectedFilename} (å…± ${fileData.data.length} é …)</h3>` + 
                generateHtmlTable(fileData.data, headers, true);
        }
        
        function renderItemView(keyName, valueColumns) {
            const valueColNames = Array.isArray(valueColumns) ? valueColumns : valueColumns.map(c => c.customName || c.autoHeader);
            itemDropdown.innerHTML = '<option value="">--- è«‹é¸æ“‡è¦æŸ¥è©¢çš„é …ç›® ---</option>' + 
                state.orderedItemKeys.map(item => `<option value="${item}">${item}</option>`).join('');
            document.getElementById('item-detail-table').innerHTML = '';
            itemDropdown.dataset.keyName = keyName;
            itemDropdown.dataset.valueColumns = JSON.stringify(valueColNames);
        }
        
        function renderItemDetailView() {
            const selectedItem = itemDropdown.value;
            const container = document.getElementById('item-detail-table');
            if (!selectedItem) {
                container.innerHTML = '';
                return;
            }
            
            const keyName = itemDropdown.dataset.keyName;
            const valueColNames = JSON.parse(itemDropdown.dataset.valueColumns);
            const headers = ['æª”æ¡ˆåç¨±', ...valueColNames];
            
            // ğŸ’¡ åªé¡¯ç¤ºè¢«æˆåŠŸè™•ç†çš„æª”æ¡ˆ
            const data = state.allFileData.map(file => {
                const row = file.data.find(r => r[keyName] === selectedItem);
                const dataRow = { 'æª”æ¡ˆåç¨±': file.fileName };
                valueColNames.forEach(colName => {
                    dataRow[colName] = row ? (row[colName] || 0) : 0;
                });
                return dataRow;
            });
            
            const summaryRow = state.summaryData.get(selectedItem);
            if (summaryRow) {
                const totalRow = { 'æª”æ¡ˆåç¨±': '<strong>ğŸ“Š åˆè¨ˆ</strong>' };
                valueColNames.forEach(colName => {
                    totalRow[colName] = summaryRow[colName] || 0;
                });
                data.unshift(totalRow);
            }
            
            container.innerHTML = 
                `<h3 style="margin-bottom:20px; color:#667eea;">ğŸ” é …ç›®æŸ¥è©¢ï¼š${selectedItem}</h3>` + 
                generateHtmlTable(data, headers, true, 'total-row');
        }
        
        function setupTabs() {
            document.querySelector('.view-tabs').addEventListener('click', e => {
                if (e.target.classList.contains('tab-btn')) {
                    const targetView = e.target.dataset.view;
                    document.querySelectorAll('.tab-btn').forEach(btn => 
                        btn.classList.toggle('active', btn.dataset.view === targetView)
                    );
                    document.querySelectorAll('.view-pane').forEach(pane => 
                        pane.classList.toggle('active', pane.id === targetView)
                    );
                }
            });
        }
        
        updateStep(1);
        setupTabs();
    </script>
</body>
</html>
