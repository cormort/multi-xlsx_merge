<!DOCTYPE html>
<html lang="zh-Hant">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>åŸºé‡‘è³‡æ–™å½™ç¸½å ±å‘Šç”¢ç”Ÿå™¨ (v10.0-opt)</title>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
Â  Â  Â  Â  Â  Â  line-height: 1.6; background: #f4f7f6; color: #333; padding:20px; max-width:1400px; margin:0 auto;
Â  Â  Â  Â  }
Â  Â  Â  Â  h1,h2,h3{color:#0056b3;}
Â  Â  Â  Â  h2{border-bottom:2px solid #e0e0e0; padding-bottom:5px;}
Â  Â  Â  Â  #app-container{background:#fff;border-radius:8px;box-shadow:0 4px 12px #0001;padding:25px;}
Â  Â  Â  Â  .config-section,.preview-section,.mapping-section,.output-section{margin-bottom:30px;}
Â  Â  Â  Â  #drop-area{border:2px dashed #007bff;border-radius:8px;padding:40px;text-align:center;background:#f8faff;color:#0056b3;font-size:1.1em;cursor:pointer;transition:.3s;}
Â  Â  Â  Â  #drop-area:hover{background:#e6f0ff;} #drop-area.minimized{padding:15px;font-size:.95em;}
Â  Â  Â  Â  #file-input{display:none;} #file-list-display{list-style:none;padding:0;margin-top:10px;}
Â  Â  Â  Â  #file-list-display li{font-size:.9em;color:#555;}
Â  Â  Â  Â  #preview-area{max-height:400px;overflow:auto;border:1px solid #ddd;border-radius:5px;background:#fafafa;margin-top:15px;}
Â  Â  Â  Â  #preview-area table,.report-table{width:100%;border-collapse:collapse;font-size:.9em;}
Â  Â  Â  Â  #preview-area th,#preview-area td,.report-table th,.report-table td{border:1px solid #ccc;padding:6px 8px;min-width:80px;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
Â  Â  Â  Â  #preview-area thead th,.report-table thead th{position:-webkit-sticky;position:sticky;top:0;background:#e9ecef;z-index:10;}
Â  Â  Â  Â  #preview-area tbody th,.report-table tbody th{position:-webkit-sticky;position:sticky;left:0;background:#f1f3f5;z-index:5;}
Â  Â  Â  Â  #preview-area thead th:first-child,.report-table thead th:first-child{left:0;z-index:20;background:#e0e0e0;}
Â  Â  Â  Â  .omitted-row-cell{text-align:center;color:#777;font-style:italic;background:#f9f9f9;}
Â  Â  Â  Â  .report-table td.number{text-align:right;font-family:monospace;}
Â  Â  Â  Â  .input-group{margin-top:15px;}
Â  Â  Â  Â  .input-group label{display:block;font-weight:bold;margin-bottom:5px;color:#555;}
Â  Â  Â  Â  .input-group input[type="text"],.input-group input[type="number"],.input-group select{width:100%;max-width:300px;padding:8px 10px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;}
Â  Â  Â  Â  button{background:#007bff;color:#fff;border:none;padding:10px 18px;border-radius:5px;cursor:pointer;font-size:1em;font-weight:500;transition:.2s;margin-right:10px;}
Â  Â  Â  Â  button:hover{background:#0056b3;}
Â  Â  Â  Â  button:disabled{background:#c0c0c0;cursor:not-allowed;}
Â  Â  Â  Â  #load-headers-btn{background:#28a745;} #load-headers-btn:hover{background:#218838;}
Â  Â  Â  Â  #mapping-fields{display:none;padding-top:15px;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* æ¬„ä½æ˜ å°„è¡¨æ ¼æ¨£å¼ */
Â  Â  Â  Â  .mapping-table-container{margin-top:20px;overflow-x:auto;}
Â  Â  Â  Â  .mapping-table{width:100%;border-collapse:collapse;background:#fff;}
Â  Â  Â  Â  .mapping-table th{background:#007bff;color:#fff;padding:12px;text-align:left;font-weight:600;}
Â  Â  Â  Â  .mapping-table td{padding:10px;border-bottom:1px solid #e0e0e0;}
Â  Â  Â  Â  .mapping-table tr:hover{background:#f8f9fa;}
Â  Â  Â  Â  .mapping-table input[type="text"]{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;}
Â  Â  Â  Â  .mapping-table select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;background:#fff;}
Â  Â  Â  Â  .mapping-table .col-excel{width:120px;font-family:monospace;color:#0056b3;font-weight:600;}
Â  Â  Â  Â  .mapping-table .col-auto-header{max-width:200px;color:#666;font-size:0.9em;}
Â  Â  Â  Â  .mapping-table .col-custom-name{min-width:200px;}
Â  Â  Â  Â  .mapping-table .col-role{width:150px;}
Â  Â  Â  Â  .mapping-table .col-include{width:80px;text-align:center;}
Â  Â  Â  Â  .mapping-table input[type="checkbox"]{width:20px;height:20px;cursor:pointer;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  .role-key{background:#ffc107;color:#000;padding:3px 8px;border-radius:3px;font-size:0.85em;font-weight:600;}
Â  Â  Â  Â  .role-value{background:#28a745;color:#fff;padding:3px 8px;border-radius:3px;font-size:0.85em;font-weight:600;}
Â  Â  Â  Â  .role-ignore{background:#6c757d;color:#fff;padding:3px 8px;border-radius:3px;font-size:0.85em;font-weight:600;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  .hint-text{color:#666;font-size:0.9em;margin-top:10px;padding:10px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:4px;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  .output-section{display:none;}
Â  Â  Â  Â  .view-tabs{border-bottom:2px solid #dee2e6;margin-bottom:15px;}
Â  Â  Â  Â  .tab-btn{background:transparent;color:#0056b3;border:none;padding:10px 15px;cursor:pointer;font-size:1.1em;margin-right:5px;border-radius:5px 5px 0 0;transition:.2s;}
Â  Â  Â  Â  .tab-btn:hover{background:#e6f0ff;}
Â  Â  Â  Â  .tab-btn.active{background:#0056b3;color:#fff;} .view-pane{display:none;padding:10px;}
Â  Â  Â  Â  .view-pane.active{display:block;} #item-view select{font-size:1.1em;padding:8px;margin-bottom:15px;}
Â  Â  Â  Â  #individual-view .individual-report{margin-bottom:30px;border-bottom:2px solid #0056b3;padding-bottom:15px;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  .merge-hint{background:#fff3cd;border:2px dashed #ffc107;}
Â  Â  Â  Â  .text-center{text-align:center;}
Â  Â  Â  Â  .text-muted{color:#888;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  #progress-container{height:22px;background:#e5e9f2;border-radius:8px;overflow:hidden;margin-bottom:8px;display:none;}
* Â  Â  Â  #progress-bar{height:100%;background:#007bff;width:0%;transition:.25s;}
Â  Â  Â  Â  #progress-text{margin-left:8px;}
Â  Â  Â  Â Â 
Â  Â  Â  Â  .auto-detect-info{background:#d1ecf1;border-left:4px solid #17a2b8;padding:10px;margin:10px 0;border-radius:4px;font-size:0.9em;}
Â  Â  Â  Â  .auto-detect-info strong{color:#0c5460;}
Â  Â  </style>
</head>
<body>
<div id="app-container">
Â  Â  <h1>åŸºé‡‘è³‡æ–™å½™ç¸½å ±å‘Šç”¢ç”Ÿå™¨ (v10.0-opt)</h1>
Â  Â Â 
Â  Â  <div class="config-section">
Â  Â  Â  Â  <h2>1. ä¸Šå‚³å¤šå€‹æª”æ¡ˆ</h2>
Â  Â  Â  Â  <div id="drop-area">æ‹–æ›³ <b>å¤šå€‹</b> Excel æª”æ¡ˆè‡³æ­¤ï¼Œæˆ–é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆ
Â  Â  Â  Â  Â  Â  <input type="file" id="file-input" accept=".xlsx,.xls" multiple>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <ul id="file-list-display"></ul>
Â  Â  Â  Â  <div id="progress-container"><div id="progress-bar"></div><span id="progress-text">0%</span></div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="preview-section">
Â  Â  Â  Â  <h2>2. æª”æ¡ˆé è¦½ (ç¬¬ä¸€å€‹æª”æ¡ˆ)</h2>
Â  Â  Â  Â  <div id="preview-area"><p style="padding:20px;text-align:center;color:#777;">å°šæœªè¼‰å…¥æª”æ¡ˆ</p></div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="config-section">
Â  Â  Â  Â  <h2>3. è¨­å®šè³‡æ–™ç¯„åœ (å°‡å¥—ç”¨è‡³æ‰€æœ‰æª”æ¡ˆ)</h2>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  <label for="data-range">è³‡æ–™ç¯„åœ (å«æ¨™é ­åˆ—)</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="data-range" placeholder="ä¾‹å¦‚: A5:G50 (åŒ…å«æ¨™é ­é‚£ä¸€åˆ—)">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  <button id="load-headers-btn" disabled>è‡ªå‹•åµæ¸¬ç¯„åœä¸¦è®€å–æ¬„ä½</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="auto-detect-result"></div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="mapping-section">
Â  Â  Â  Â  <h2>4. æ¬„ä½è¨­å®šèˆ‡å°æ‡‰</h2>
Â  Â  Â  Â  <div class="hint-text">
Â  Â  Â  Â  Â  Â  <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong><br>
Â  Â  Â  Â  Â  Â  â€¢ <span class="role-key">ä¸»éµæ¬„ä½</span>ï¼šé¸æ“‡ä¸€å€‹æ¬„ä½ä½œç‚ºé …ç›®/ç§‘ç›®çš„è­˜åˆ¥æ¬„ä½ï¼ˆå¿…é ˆé¸æ“‡ä¸€å€‹ï¼‰<br>
Â  Â  Â  Â  Â  Â  â€¢ <span class="role-value">åŠ ç¸½æ¬„ä½</span>ï¼šé¸æ“‡è¦åŠ ç¸½çš„æ•¸å€¼æ¬„ä½ï¼ˆå¯å¤šé¸ï¼‰<br>
Â  Â  Â  Â  Â  Â  â€¢ <span class="role-ignore">å¿½ç•¥</span>ï¼šä¸ä½¿ç”¨æ­¤æ¬„ä½<br>
Â  Â  Â  Â  Â  Â  â€¢ å¯ä»¥è‡ªè¨‚ã€Œå ±è¡¨æ¬„ä½åç¨±ã€ï¼Œè‹¥ä¸å¡«å¯«å‰‡ä½¿ç”¨ Excel æ¬„ä½åç¨±
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="mapping-fields"></div>
Â  Â  Â  Â  <p id="mapping-placeholder" style="color:#777;">è«‹å…ˆè®€å–æ¬„ä½ä»¥é¡¯ç¤ºå°æ‡‰è¡¨æ ¼</p>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="config-section">
Â  Â  Â  Â  <button id="process-btn" disabled>é–‹å§‹å½™ç¸½è™•ç†</button>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="output-section" id="output-area">
Â  Â  Â  Â  <h2>5. å½™ç¸½å ±å‘Šçµæœ</h2>
Â  Â  Â  Â  <div class="view-tabs">
Â  Â  Â  Â  Â  Â  <button class="tab-btn active" data-view="summary-view">åŠ ç¸½ç¸½è¡¨</button>
Â  Â  Â  Â  Â  Â  <button class="tab-btn" data-view="individual-view">å€‹åˆ¥æª”æ¡ˆ</button>
Â  Â  Â  Â  Â  Â  <button class="tab-btn" data-view="item-view">é …ç›®æŸ¥è©¢</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="view-content">
Â  Â  Â  Â  Â  Â  <div id="summary-view" class="view-pane active"></div>
Â  Â  Â  Â  Â  Â  <div id="individual-view" class="view-pane"></div>
Â  Â  Â  Â  Â  Â  <div id="item-view" class="view-pane">
Â  Â  Â  Â  Â  Â  Â  Â  <select id="item-dropdown"></select>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="item-detail-table"></div>
section Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
const state = {
Â  Â  workbooks:[],Â 
Â  Â  allFileData:[],Â 
Â  Â  summaryData:new Map(),Â 
Â  Â  columnMappings:[], // [{excelCol, autoHeader, customName, role:'key'|'value'|'ignore', include:true/false}]
Â  Â  detectedRange:null
};

// DOM Elements
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
const fileListDisplay = document.getElementById('file-list-display');
const progressContainer = document.getElementById('progress-container');
const progressBar = document.getElementById('progress-bar');
const progressText = document.getElementById('progress-text');
const previewArea = document.getElementById('preview-area');
const dataRangeInput = document.getElementById('data-range');
const loadHeadersBtn = document.getElementById('load-headers-btn');
const mappingFields = document.getElementById('mapping-fields');
const mappingPlaceholder = document.getElementById('mapping-placeholder');
const processBtn = document.getElementById('process-btn');
const outputArea = document.getElementById('output-area');
const itemDropdown = document.getElementById('item-dropdown');
const autoDetectResult = document.getElementById('auto-detect-result');

// äº‹ä»¶ç›£è½åˆå§‹åŒ–
dropArea.addEventListener('click', () => fileInput.click());

// --- ä¿®æ­£ 1ï¼šè£œå…¨ dragenter äº‹ä»¶ä¸¦èª¿æ•´ highlight é‚è¼¯ ---
dropArea.addEventListener('dragenter', e => {
Â  Â  e.preventDefault();
Â  Â  dropArea.style.backgroundColor = '#e6f0ff';
});
dropArea.addEventListener('dragover', e => {
Â  Â  e.preventDefault(); // å¿…é ˆä¿ç•™ï¼Œé˜²æ­¢ç€è¦½å™¨é–‹å•Ÿæª”æ¡ˆ
});
dropArea.addEventListener('dragleave', e => {
Â  Â  // åªæœ‰ç•¶æ»‘é¼ é›¢é–‹ dropArea (è€Œä¸æ˜¯é€²å…¥å­å…ƒç´ ) æ™‚æ‰æ¢å¾©æ¨£å¼
Â  Â  if (e.relatedTarget === null || !dropArea.contains(e.relatedTarget)) {
Â  Â  Â  Â  dropArea.style.backgroundColor = '#f8faff';
Â  Â  }
});
dropArea.addEventListener('drop', e => {
Â  Â  e.preventDefault();
Â  Â  dropArea.style.backgroundColor = '#f8faff';
Â  Â  if(e.dataTransfer.files.length > 0) {
Â  Â  Â  Â  fileInput.files = e.dataTransfer.files;
Â  Â  Â  Â  handleFiles(fileInput.files);
Â  Â  }
});
fileInput.addEventListener('change', e => {
Â  Â  if(e.target.files.length > 0) {
Â  Â  Â  Â  handleFiles(e.target.files);
Â  Â  }
});
loadHeadersBtn.addEventListener('click', loadHeadersAndDetectRange);
processBtn.addEventListener('click', processData);
itemDropdown.addEventListener('change', renderItemDetailView);
// --- ä¿®æ­£ 2ï¼šç§»é™¤äº†é€™è£¡çš„ setupTabs() å‘¼å« ---

// è¨­å®šè¨˜æ†¶
function saveSetting() {
Â  Â  localStorage.setItem('excelMergeSettings', JSON.stringify({
Â  Â  Â  Â  range: dataRangeInput.value
Â  Â  }));
}

function loadSetting() {
Â  Â  try {
Â  Â  Â  Â  const settings = JSON.parse(localStorage.getItem('excelMergeSettings'));
Â  Â  Â  Â  if(settings) {
Â  Â  Â  Â  Â  Â  dataRangeInput.value = settings.range || '';
Â  Â  Â  Â  }
Â  Â  } catch(e) {}
}
// --- ä¿®æ­£ 2ï¼šç§»é™¤äº†é€™è£¡çš„ loadSetting() å‘¼å« ---

// æª”æ¡ˆè®€å–
function readFile(file) {
Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = e => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const workbook = XLSX.read(e.target.result, {type: 'array'});
Â  Â  Â  Â  Â  Â  Â  Â  resolve({file, workbook});
Â  Â  Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  Â  Â  Â  reject(err);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.onerror = err => reject(err);
Â  Â  Â  Â  reader.readAsArrayBuffer(file);
Â  Â  });
}

async function handleFiles(fileList) {
Â  Â  if([...fileList].some(f => f.size > 10*1024*1024)) {
Â  Â  Â  Â  alert('æª”æ¡ˆéå¤§ï¼Œè«‹åˆ†æ‰¹ä¸Šå‚³ï¼');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  dropArea.innerHTML = 'æ­£åœ¨è®€å–èˆ‡è§£ææª”æ¡ˆ...';
Â  Â  previewArea.innerHTML = '<p style="padding:20px;text-align:center;">æ­£åœ¨è®€å–èˆ‡è§£ææª”æ¡ˆ...</p>';
Â  Â  fileListDisplay.innerHTML = '';
Â  Â  state.workbooks = [];
Â  Â  progressBar.style.width = "0%";
Â  Â  progressText.textContent = "0%";
Â  Â  progressContainer.style.display = "block";
Â  Â Â 
Â  Â  const filePromises = Array.from(fileList).map(readFile);
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const results = await Promise.all(filePromises.map((p, i) => p.then(res => {
Â  Â  Â  Â  Â  Â  let pct = Math.round(((i+1)/fileList.length)*100);
Â  Â  Â  Â  Â  Â  progressBar.style.width = pct + "%";
Â  Â  Â  Â  Â  Â  progressText.textContent = pct + "%";
Â  Â  Â  Â  Â  Â  return res;
Â  Â  Â  Â  })));
Â  Â  Â  Â Â 
Â  Â  Â  Â  state.workbooks = results;
Â  Â  Â  Â  fileListDisplay.innerHTML = 'å·²è¼‰å…¥æª”æ¡ˆï¼š' + state.workbooks.map(wb => `<li>- ${wb.file.name}</li>`).join('');
Â  Â  Â  Â  dropArea.innerHTML = 'é»æ“Šæˆ–æ‹–æ›³æ›´æ›æª”æ¡ˆ';
Â  Â  Â  Â  dropArea.classList.add('minimized');
Â  Â  Â  Â  progressContainer.style.display = "none";
Â  Â  Â  Â Â 
Â  Â  Â  Â  generatePreview(state.workbooks[0].workbook.Sheets[state.workbooks[0].workbook.SheetNames[0]]);
Â  Â  Â  Â  loadHeadersBtn.disabled = false;
Â  Â  Â  Â Â 
Â  Â  } catch(err) {
Â  Â  Â  Â  previewArea.innerHTML = `<p style="padding:20px;text-align:center;color:red;">æª”æ¡ˆè§£æå¤±æ•—ï¼š${err.message}</p>`;
Â  Â  Â  Â  dropArea.classList.remove('minimized');
Â  Â  Â  Â  dropArea.innerHTML = 'æ‹–æ›³ <b>å¤šå€‹</b> Excel æª”æ¡ˆè‡³æ­¤ï¼Œæˆ–é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆ';
Â  Â  Â  Â  progressContainer.style.display = "none";
Â  Â  }
}

// é è¦½åŠŸèƒ½
function generatePreview(sheet) {
Â  Â  if(!sheet || !sheet['!ref']) {
Â  Â  Â  Â  previewArea.innerHTML = '<p class="text-center text-muted">å·¥ä½œè¡¨ç‚ºç©º</p>';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  const fullRange = XLSX.utils.decode_range(sheet['!ref']);
Â  Â  const minCol = fullRange.s.c, maxCol = fullRange.e.c;
Â  Â  const minRow = fullRange.s.r, maxRow = fullRange.e.r;
Â  Â  const merges = sheet['!merges'] || [];
Â  Â Â 
Â  Â  let html = '<table><thead><tr><th></th>';
Â  Â  for(let C = minCol; C <= maxCol; ++C) {
Â  Â  Â  Â  html += '<th>' + XLSX.utils.encode_col(C) + '</th>';
Â  Â  }
Â  Â  html += '</tr></thead><tbody>';
Â  Â Â 
Â  Â  const totalRows = maxRow - minRow + 1;
Â  Â  const colCount = maxCol - minCol + 1;
Â  Â Â 
Â  Â  const renderRows = (s, e) => {
Â  Â  Â  Â  let range = {s:{r:s, c:minCol}, e:{r:e, c:maxCol}};
Â  Â  Â  Â  const rows = XLSX.utils.sheet_to_json(sheet, {
Â  Â  Â  Â  Â  Â  header: 1,
Â  Â  Â  Â  Â  Â  range: XLSX.utils.encode_range(range),
Â  Â  Â  Â  Â  Â  defval: ''
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  rows.forEach((row, rowIdx) => {
Â  Â  Â  Â  Â  Â  const excelRowNum = s + rowIdx + 1;
Â  Â  Â  Â  Â  Â  html += '<tr><th>' + excelRowNum + '</th>';
Â  Â  Â  Â  Â  Â  for(let c = 0; c < colCount; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  let cellAddress = XLSX.utils.encode_cell({r: s+rowIdx, c: minCol+c});
Â  Â  Â  Â  Â  Â  Â  Â  let isMerged = merges.find(m =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (s+rowIdx) >= m.s.r && (s+rowIdx) <= m.e.r &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (minCol+c) >= m.s.c && (minCol+c) <= m.e.c
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  html += `<td${isMerged ? ' class="merge-hint"' : ''}>${row[c] != null ? row[c] : ''}</td>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  html += '</tr>';
Â  Â  Â  Â  });
Â  Â  };
Â  Â Â 
Â  Â  if(totalRows <= 11) {
Â  Â  Â  Â  renderRows(minRow, maxRow);
Â  Â  } else {
Â  Â  Â  Â  renderRows(minRow, minRow + 4);
Â  Â  Â  Â  html += `<tr><th>...</th><td colspan="${colCount}" class="omitted-row-cell">... (çœç•¥${totalRows-10}åˆ—) ...</td></tr>`;
Â  Â  Â  Â  renderRows(maxRow - 4, maxRow);
Â  Â  }
Â  Â Â 
Â  Â  html += '</tbody></table>';
Â  Â  previewArea.innerHTML = html;
}

// è‡ªå‹•åµæ¸¬è³‡æ–™ç¯„åœ
function autoDetectDataRange(sheet) {
Â  Â  if(!sheet || !sheet['!ref']) return null;
Â  Â Â 
Â  Â  const fullRange = XLSX.utils.decode_range(sheet['!ref']);
Â  Â  const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: null});
Â  Â Â 
Â  Â  // æ‰¾ç¬¬ä¸€å€‹éç©ºåˆ—ä½œç‚ºæ¨™é ­
Â  Â  let headerRowIdx = -1;
Â  Â  for(let i = 0; i < rows.length; i++) {
Â  Â  Â  Â  if(rows[i] && rows[i].some(cell => cell != null && String(cell).trim() !== '')) {
Â  Â  Â  Â  Â  Â  headerRowIdx = i;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  if(headerRowIdx === -1) return null;
Â  Â Â 
Â  Â  // æ‰¾æœ€å¾Œä¸€å€‹éç©ºåˆ—
Â  Â  let lastDataRowIdx = headerRowIdx;
Â  Â  for(let i = rows.length - 1; i > headerRowIdx; i--) {
Â  Â  Â  Â  if(rows[i] && rows[i].some(cell => cell != null && String(cell).trim() !== '')) {
Â  Â  Â  Â  Â  Â  lastDataRowIdx = i;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // æ‰¾æœ‰æ•ˆæ¬„ä½ç¯„åœ
Â  Â  const headerRow = rows[headerRowIdx];
Â  Â  let firstCol = 0, lastCol = headerRow.length - 1;
Â  Â Â 
Â  Â  // æ‰¾ç¬¬ä¸€å€‹éç©ºæ¬„
Â  Â  for(let c = 0; c < headerRow.length; c++) {
Â  Â  Â  Â  let hasData = false;
Â  Â  Â  Â  for(let r = headerRowIdx; r <= lastDataRowIdx; r++) {
Â  Â  Â  Â  Â  Â  if(rows[r] && rows[r][c] != null && String(rows[r][c]).trim() !== '') {
Â  Â  Â  Â  Â  Â  Â  Â  hasData = true;
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if(hasData) {
Â  Â  Â  Â  Â  Â  firstCol = c;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // æ‰¾æœ€å¾Œä¸€å€‹éç©ºæ¬„
Â  Â  for(let c = headerRow.length - 1; c >= 0; c--) {
Â  Â  Â  Â  let hasData = false;
Â  Â  Â  Â  for(let r = headerRowIdx; r <= lastDataRowIdx; r++) {
Â  Â  Â  Â  Â  Â  if(rows[r] && rows[r][c] != null && String(rows[r][c]).trim() !== '') {
Â  Â  Â  Â  Â  Â  Â  Â  hasData = true;
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if(hasData) {
Â  Â  Â  Â  Â  Â  lastCol = c;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  return {
Â  Â  Â  Â  range: XLSX.utils.encode_range({
Â  Â  Â  Â  Â  Â  s: {r: headerRowIdx, c: firstCol},
Â  Â  Â  Â  Â  Â  e: {r: lastDataRowIdx, c: lastCol}
Â  Â  Â  Â  }),
Â  Â  Â  Â  headerRowIdx: headerRowIdx,
Â  Â  Â  Â  firstCol: firstCol,
Â  Â  Â  Â  lastCol: lastCol
Â  Â  };
}

// è®€å–æ¨™é ­ä¸¦å»ºç«‹æ˜ å°„è¡¨æ ¼
function loadHeadersAndDetectRange() {
Â  Â  if(state.workbooks.length === 0) {
Â  Â  Â  Â  alert('è«‹å…ˆä¸Šå‚³æª”æ¡ˆ');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  const sheet = state.workbooks[0].workbook.Sheets[state.workbooks[0].workbook.SheetNames[0]];
Â  Â  let rangeStr = dataRangeInput.value.trim();
Â  Â Â 
Â  Â  // è‡ªå‹•åµæ¸¬ç¯„åœ
Â  Â  if(!rangeStr) {
Â  Â  Â  Â  const detected = autoDetectDataRange(sheet);
Â  Â  Â  Â  if(detected) {
Â  Â  Â  Â  Â  Â  rangeStr = detected.range;
Â  Â  Â  Â  Â  Â  dataRangeInput.value = rangeStr;
Â  Â  Â  Â  Â  Â  state.detectedRange = detected;
Â  Â  Â  Â  Â  Â  autoDetectResult.innerHTML = `<div class="auto-detect-info"><strong>âœ“ è‡ªå‹•åµæ¸¬æˆåŠŸ</strong><br>åµæ¸¬åˆ°è³‡æ–™ç¯„åœï¼š${rangeStr}</div>`;
i Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert('ç„¡æ³•è‡ªå‹•åµæ¸¬ç¯„åœï¼Œè«‹æ‰‹å‹•è¼¸å…¥');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  saveSetting();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const range = XLSX.utils.decode_range(rangeStr);
Â  Â  Â  Â  const headerRowIdx = range.s.r;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // è®€å–æ¨™é ­åˆ—å’Œä¸‹ä¸€åˆ—çš„è³‡æ–™ä¾†åˆ¤æ–·
Â  Â  Â  Â  const headerData = XLSX.utils.sheet_to_json(sheet, {
Â  Â  Â  Â  Â  Â  header: 1,
Â  Â  Â  Â  Â  Â  range: XLSX.utils.encode_range({
Â  Â  Â  Â  Â  Â  Â  Â  s: {r: headerRowIdx, c: range.s.c},
Â  Â  Â  Â  Â  Â  Â  Â  e: {r: headerRowIdx + 1, c: range.e.c}
Â  Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  Â  defval: ''
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const headerRow = headerData[0] || [];
Â  Â  Â  Â  const sampleDataRow = headerData[1] || [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  // å»ºç«‹æ¬„ä½æ˜ å°„
Â  Â  Â  Â  state.columnMappings = [];
Â  Â  Â  Â  for(let C = range.s.c; C <= range.e.c; ++C) {
Â  Â  Â  Â  Â  Â  const colIdx = C - range.s.c;
Â  Â  Â  Â  Â  Â  const excelCol = XLSX.utils.encode_col(C);
Â  Â  Â  Â  Â  Â  const autoHeader = headerRow[colIdx] ? String(headerRow[colIdx]).trim() : '';
Â  Â  Â  Â  Â  Â  const sampleValue = sampleDataRow[colIdx];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // è‡ªå‹•åˆ¤æ–·è§’è‰²
Â  Â  Â  Â  Â  Â  let autoRole = 'ignore';
Â  Â  Â  Â  Â  Â  if(autoHeader) {
Â  Â  Â  Â  Â  Â  Â  Â  // åŒ…å«"ç§‘ç›®"ã€"é …ç›®"ã€"åç¨±"ç­‰é—œéµå­—çš„è¨­ç‚ºä¸»éµ
Â  Â  Â  Â  Â  Â  Â  Â  if(/ç§‘ç›®|é …ç›®|åç¨±|é¡åˆ¥|å“é …/.test(autoHeader)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  autoRole = 'key';
Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  // æ•¸å­—æ¬„ä½è¨­ç‚ºåŠ ç¸½æ¬„ä½
Â  Â  Â  Â  Â  Â  Â  Â  else if(typeof sampleValue === 'number' || !isNaN(parseFloat(sampleValue))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  autoRole = 'value';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  state.columnMappings.push({
Â  Â  Â  Â  Â  Â  Â  Â  excelCol: excelCol,
Â  Â  Â  Â  Â  Â  Â  Â  autoHeader: autoHeader || `(æ¬„ ${excelCol})`,
Â  Â  Â  Â  Â  Â  Â  Â  customName: autoHeader || '',
Â  Â  Â  Â  Â  Â  Â  Â  role: autoRole,
Â  Â  Â  Â  Â  Â  Â  Â  include: autoRole !== 'ignore'
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  renderMappingTable();
Â  Â  Â  Â  mappingFields.style.display = 'block';
Â  Â  Â  Â  mappingPlaceholder.style.display = 'none';
Â  Â  Â  Â  processBtn.disabled = false;
Â  Â  Â  Â Â 
Â  Â  } catch(err) {
Â  Â  Â  Â  alert(`è®€å–æ¬„ä½å¤±æ•—ï¼š${err.message}`);
Â  Â  }
}

// æ¸²æŸ“æ˜ å°„è¡¨æ ¼
function renderMappingTable() {
Â  Â  let html = `
Â  Â  <div class="mapping-table-container">
Â  Â  Â  Â  <table class="mapping-table">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="col-excel">Excel æ¬„ä½</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="col-auto-header">åŸå§‹æ¨™é ­</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="col-custom-name">å ±è¡¨æ¬„ä½åç¨± (å¯è‡ªè¨‚)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="col-role">æ¬„ä½è§’è‰²</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="col-include">ä½¿ç”¨</th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  `;
Â  Â Â 
Â  Â  state.columnMappings.forEach((col, idx) => {
Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="col-excel">${col.excelCol}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="col-auto-header">${col.autoHeader}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="col-custom-name">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-idx="${idx}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="custom-name-input"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â value="${col.customName}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="è¼¸å…¥è‡ªè¨‚åç¨±">
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="col-role">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select data-idx="${idx}" class="role-select">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="ignore" ${col.role === 'ignore' ? 'selected' : ''}>å¿½ç•¥</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="key" ${col.role === 'key' ? 'selected' : ''}>ä¸»éµæ¬„ä½</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="value" ${col.role === 'value' ? 'selected' : ''}>åŠ ç¸½æ¬„ä½</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="col-include">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data-idx="${idx}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="include-checkbox"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${col.include ? 'checked' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  });
Â  Â Â 
Â  Â  html += `
Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  </div>
Â  Â  `;
Â  Â Â 
Â  Â  mappingFields.innerHTML = html;
Â  Â Â 
Â  Â  // ç¶å®šäº‹ä»¶
Â  Â  document.querySelectorAll('.custom-name-input').forEach(input => {
Â  Â  Â  Â  input.addEventListener('input', e => {
Â  Â  Â  Â  Â  Â  const idx = parseInt(e.target.dataset.idx);
Â  Â  Â  Â  Â  Â  state.columnMappings[idx].customName = e.target.value.trim();
Â  Â  Â  Â  });
Â  Â  });
Â  Â Â 
Â  Â  document.querySelectorAll('.role-select').forEach(select => {
Â  Â  Â  Â  select.addEventListener('change', e => {
Â  Â  Â  Â  Â  Â  const idx = parseInt(e.target.dataset.idx);
Â  Â  Â  Â  Â  Â  state.columnMappings[idx].role = e.target.value;
Â  Â  Â  Â  Â  Â  // è‡ªå‹•å‹¾é¸/å–æ¶ˆå‹¾é¸
Â  Â  Â  Â  Â  Â  const checkbox = document.querySelector(`.include-checkbox[data-idx="${idx}"]`);
Â  Â  Â  Â  Â  Â  if(e.target.value !== 'ignore') {
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.checked = true;
Â  Â  Â  Â  Â  Â  Â  Â  state.columnMappings[idx].include = true;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.checked = false;
Â  Â  Â  Â  Â  Â  Â  Â  state.columnMappings[idx].include = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  });
Â  Â Â 
Â  Â  document.querySelectorAll('.include-checkbox').forEach(checkbox => {
Â  Â  Â  Â  checkbox.addEventListener('change', e => {
Â  Â  Â  Â  Â  Â  const idx = parseInt(e.target.dataset.idx);
Â  Â  Â  Â  Â  Â  state.columnMappings[idx].include = e.target.checked;
Â  Â  Â  Â  });
Â  Â  });
}

// è™•ç†è³‡æ–™
function processData() {
Â  Â  // é©—è­‰æ˜ å°„è¨­å®š
Â  Â  const keyColumns = state.columnMappings.filter(c => c.role === 'key' && c.include);
Â  Â  const valueColumns = state.columnMappings.filter(c => c.role === 'value' && c.include);
Â  Â Â 
Â  Â  if(keyColumns.length === 0) {
Â  Â  Â  Â  alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ä¸»éµæ¬„ä½ï¼');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if(keyColumns.length > 1) {
Â  Â  Â  Â  alert('åªèƒ½é¸æ“‡ä¸€å€‹ä¸»éµæ¬„ä½ï¼');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if(valueColumns.length === 0) {
Â  Â  Â  Â  alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹åŠ ç¸½æ¬„ä½ï¼');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  const keyCol = keyColumns[0];
Â  Â  const keyName = keyCol.customName || keyCol.autoHeader;
Â  Â Â 
Â  Â  const rangeStr = dataRangeInput.value.trim();
Â  Â  if(!rangeStr) {
Â  Â  Â  Â  alert('è«‹è¼¸å…¥è³‡æ–™ç¯„åœï¼');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  // é‡ç½®ç‹€æ…‹
Â  Â  state.allFileData = [];
Â  Â  state.summaryData = new Map();
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const range = XLSX.utils.decode_range(rangeStr);
Â  Â  Â  Â  const headerRowIdx = range.s.r;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // è™•ç†æ¯å€‹æª”æ¡ˆ
Â  Â  Â  Â  state.workbooks.forEach(wb => {
Â  Â  Â  Â  Â  Â  const sheet = wb.workbook.Sheets[wb.workbook.SheetNames[0]];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // è®€å–æ‰€æœ‰è³‡æ–™ï¼ˆä¸å«æ¨™é ­ï¼‰
Â  Â  Â  Â  Â  Â  const dataRows = XLSX.utils.sheet_to_json(sheet, {
Â  Â  Â  Â  Â  Â  Â  Â  header: 1,
Â  Â  Â  Â  Â  Â  Â  Â  range: XLSX.utils.encode_range({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  s: {r: headerRowIdx + 1, c: range.s.c},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e: {r: range.e.r, c: range.e.c}
Â  Â  Â  Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  Â  Â  Â  defval: null
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // è½‰æ›è³‡æ–™æ ¼å¼
Â  Â  Â  Â  Â  Â  const transformed = [];
Â  Â  Â  Â  Â  Â  dataRows.forEach(row => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!row || row.every(cell => cell == null || String(cell).trim() === '')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // è·³éç©ºåˆ—
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const keyColIdx = keyCol.excelCol.charCodeAt(0) - 'A'.charCodeAt(0);
Â  Â  Â  Â  Â  Â  Â  Â  const keyValue = row[keyColIdx];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(!keyValue || String(keyValue).trim() === '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // è·³éä¸»éµç‚ºç©ºçš„åˆ—
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const dataRow = {};
Â  Â  Â  Â  Â  Â  Â  Â  dataRow[keyName] = String(keyValue).trim();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  valueColumns.forEach(valCol => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colIdx = valCol.excelCol.charCodeAt(0) - 'A'.charCodeAt(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colName = valCol.customName || valCol.autoHeader;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cellValue = row[colIdx];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dataRow[colName] = toNumber(cellValue);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  transformed.push(dataRow);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  state.allFileData.push({
Â  Â  Â  Â  Â  Â  Â  Â  fileName: wb.file.name,
Â  Â  Â  Â  Â  Â  Â  Â  data: transformed
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // å½™ç¸½è³‡æ–™
Â  Â  Â  Â  state.allFileData.forEach(file => {
Â  Â  Â  Â  Â  Â  file.data.forEach(row => {
Â  Â  Â  Â  Â  Â  Â  Â  const key = row[keyName];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(!state.summaryData.has(key)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const summaryRow = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  summaryRow[keyName] = key;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueColumns.forEach(valCol => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colName = valCol.customName || valCol.autoHeader;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  summaryRow[colName] = row[colName] || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.summaryData.set(key, summaryRow);
section Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const summaryRow = state.summaryData.get(key);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  valueColumns.forEach(valCol => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const colName = valCol.customName || valCol.autoHeader;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  summaryRow[colName] += (row[colName] || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // æ¸²æŸ“çµæœ
Â  Â  Â  Â  renderSummaryView(keyName, valueColumns);
Â  Â  Â  Â  renderIndividualViews(keyName, valueColumns);
Â  Â  Â  Â  renderItemView(keyName, valueColumns);
Â  Â  Â  Â Â 
Â  Â  Â  Â  outputArea.style.display = 'block';
Â  Â  Â  Â  alert(`è™•ç†å®Œæˆï¼\nå…±è™•ç† ${state.workbooks.length} å€‹æª”æ¡ˆ\nå½™ç¸½äº† ${state.summaryData.size} å€‹é …ç›®`);
config Â  Â  Â Â 
Â  Â  } catch(err) {
Â  Â  Â  Â  alert(`è™•ç†è³‡æ–™éŒ¯èª¤ï¼š${err.message}`);
Â  Â  Â  Â  console.error(err);
Â  Â  }
}

function toNumber(val) {
Â  Â  if(val == null || val === '') return 0;
Â  Â  if(typeof val === 'number') return val;
Â  Â  const num = parseFloat(val);
Â  Â  return isNaN(num) ? 0 : num;
}

// ç”Ÿæˆ HTML è¡¨æ ¼
function generateHtmlTable(data, headers, formatNumbers = false) {
Read Â  Â  let html = '<table class="report-table"><thead><tr>';
Â  Â  headers.forEach(h => html += `<th>${h}</th>`);
Â  Â  html += '</tr></thead><tbody>';
Â  Â Â 
Â  Â  data.forEach(row => {
Â  Â  Â  Â  html += '<tr>';
Â  Â  Â  Â  headers.forEach(h => {
Â  Â  Â  Â  Â  Â  const val = row[h];
Â  Â  Â  Â  Â  Â  if(formatNumbers && typeof val === 'number') {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<td class="number">${val.toFixed(2)}</td>`;
Note Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<td>${val != null ? val : ''}</td>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  html += '</tr>';
Â  Â  });
Â  Â Â 
Â  Â  html += '</tbody></table>';
Â  Â  return html;
}

// æ¸²æŸ“ç¸½è¡¨
function renderSummaryView(keyName, valueColumns) {
section Â  Â  const view = document.getElementById('summary-view');
Â  Â  const data = Array.from(state.summaryData.values());
Â  Â  const headers = [keyName, ...valueColumns.map(c => c.customName || c.autoHeader)];
Â  Â  view.innerHTML = '<h3>æ‰€æœ‰æª”æ¡ˆåŠ ç¸½çµæœ</h3>' + generateHtmlTable(data, headers, true);
}

// æ¸²æŸ“å€‹åˆ¥æª”æ¡ˆ
function renderIndividualViews(keyName, valueColumns) {
Â  Â  const view = document.getElementById('individual-view');
Â  Â  const headers = [keyName, ...valueColumns.map(c => c.customName || c.autoHeader)];
Â  Â Â 
Â  Â  let html = '';
Â  Â  state.allFileData.forEach(file => {
Â  Â  Â  Â  html += `<div class="individual-report">
Â  Â  Â  Â  Â  Â  <h3>${file.fileName}</h3>
Â  Â  Â  Â  Â  Â  ${generateHtmlTable(file.data, headers, false)}
Â  Â  Â  Â  </div>`;
Â  Â  });
Â  Â Â 
Â  Â  view.innerHTML = html;
}

// æ¸²æŸ“é …ç›®æŸ¥è©¢
function renderItemView(keyName, valueColumns) {
Read Â  Â  itemDropdown.innerHTML = '<option value="">--- è«‹é¸æ“‡è¦æŸ¥è©¢çš„é …ç›® ---</option>';
Â  Â Â 
Â  Â  Array.from(state.summaryData.keys()).sort().forEach(item => {
Â  Â  Â  Â  itemDropdown.innerHTML += `<option value="${item}">${item}</option>`;
Â  Â  });
Â  Â Â 
Â  Â  document.getElementById('item-detail-table').innerHTML = '';
Â  Â Â 
Â  Â  // ä¿å­˜æŸ¥è©¢é…ç½®
Â  Â  itemDropdown.dataset.keyName = keyName;
Â  Â  itemDropdown.dataset.valueColumns = JSON.stringify(valueColumns.map(c => c.customName || c.autoHeader));
}

// æ¸²æŸ“é …ç›®è©³ç´°è³‡æ–™
function renderItemDetailView() {
Rules Â  Â  const selectedItem = itemDropdown.value;
Â  Â  const container = document.getElementById('item-detail-table');
Â  Â Â 
Â  Â  if(!selectedItem) {
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  const keyName = itemDropdown.dataset.keyName;
Â  Â  const valueColNames = JSON.parse(itemDropdown.dataset.valueColumns);
Â  Â  const headers = ['æª”æ¡ˆåç¨±', ...valueColNames];
Â  Â Â 
Â  Â  const data = [];
Â  Â Â 
Â  Â  // æ”¶é›†æ¯å€‹æª”æ¡ˆçš„è³‡æ–™
Â  Â  state.allFileData.forEach(file => {
Â  Note Â  Â  Â  const row = file.data.find(r => r[keyName] === selectedItem);
Â  Â  Â  Â  if(row) {
Â  Â  Â  Â  Â  Â  const dataRow = {'æª”æ¡ˆåç¨±': file.fileName};
Â  Â  Â  Â  Â  Â  valueColNames.forEach(colName => {
Â  Â  Â  Â  Â  Â  Â  Â  dataRow[colName] = row[colName] || 0;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  data.push(dataRow);
Â  Â  Â  Â  }
Â  Â  });
Â  Â Â 
Â  Â  // åŠ å…¥ç¸½è¨ˆåˆ—
Â  Â  const summaryRow = state.summaryData.get(selectedItem);
Â  Â  if(summaryRow) {
Â  Â  Â  Â  const totalRow = {'æª”æ¡ˆåç¨±': '<strong>ç¸½è¨ˆ</strong>'};
Â  Â  Â  Â  valueColNames.forEach(colName => {
Â  Â  Â  Â  Â  Â  totalRow[colName] = summaryRow[colName] || 0;
rules Â  Â  Â  Â  });
Â  Â  Â  Â  data.push(totalRow);
Â  Â  }
Â  Â Â 
Â  Â  container.innerHTML = '<h3>é …ç›®ï¼š' + selectedItem + '</h3>' +Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â generateHtmlTable(data, headers, true);
}

// è¨­å®šé ç±¤åˆ‡æ›
function setupTabs() {
Â  Â  document.querySelector('.view-tabs').addEventListener('click', e => {
Â  Â  Â  Â  if(e.target.classList.contains('tab-btn')) {
Â  Â  Â  Â  Â  Â  const targetView = e.target.dataset.view;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab-btn').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.toggle('active', btn.dataset.view === targetView);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Setting Â  Â  Â  document.querySelectorAll('.view-pane').forEach(pane => {
Â  Â  Â  Â  Â  Â  Â  Â  pane.classList.toggle('active', pane.id === targetView);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });
}

// --- ä¿®æ­£ 2ï¼šå°‡å‡½å¼å‘¼å«ç§»è‡³ script çµå°¾ ---
// ç¢ºä¿æ‰€æœ‰å‡½å¼éƒ½å·²å®šç¾©å¾Œå†åŸ·è¡Œ
loadSetting();
setupTabs();

</script>
</body>
</html>
