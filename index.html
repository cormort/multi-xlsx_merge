<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金資料彙總報告產生器 (v9.1-opt)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
            line-height: 1.6; background: #f4f7f6; color: #333; padding:20px; max-width:1200px; margin:0 auto;
        }
        h1,h2,h3{color:#0056b3;}
        h2{border-bottom:2px solid #e0e0e0; padding-bottom:5px;}
        #app-container{background:#fff;border-radius:8px;box-shadow:0 4px 12px #0001;padding:25px;}
        .config-section,.preview-section,.mapping-section,.output-section{margin-bottom:30px;}
        #drop-area{border:2px dashed #007bff;border-radius:8px;padding:40px;text-align:center;background:#f8faff;color:#0056b3;font-size:1.1em;cursor:pointer;transition:.3s;}
        #drop-area:hover{background:#e6f0ff;} #drop-area.minimized{padding:15px;font-size:.95em;}
        #file-input{display:none;} #file-list-display{list-style:none;padding:0;margin-top:10px;}
        #file-list-display li{font-size:.9em;color:#555;}
        #preview-area{max-height:400px;overflow:auto;border:1px solid #ddd;border-radius:5px;background:#fafafa;margin-top:15px;}
        #preview-area table,.report-table{width:100%;border-collapse:collapse;font-size:.9em;}
        #preview-area th,#preview-area td,.report-table th,.report-table td{border:1px solid #ccc;padding:6px 8px;min-width:80px;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        #preview-area thead th,.report-table thead th{position:-webkit-sticky;position:sticky;top:0;background:#e9ecef;z-index:10;}
        #preview-area tbody th,.report-table tbody th{position:-webkit-sticky;position:sticky;left:0;background:#f1f3f5;z-index:5;}
        #preview-area thead th:first-child,.report-table thead th:first-child{left:0;z-index:20;background:#e0e0e0;}
        .omitted-row-cell{text-align:center;color:#777;font-style:italic;background:#f9f9f9;}
        .report-table td.number{text-align:right;font-family:monospace;}
        .input-group{margin-top:15px;}
        .input-group label{display:block;font-weight:bold;margin-bottom:5px;color:#555;}
        .input-group input[type="text"],.input-group input[type="number"],.input-group select{width:100%;max-width:300px;padding:8px 10px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;}
        button{background:#007bff;color:#fff;border:none;padding:10px 18px;border-radius:5px;cursor:pointer;font-size:1em;font-weight:500;transition:.2s;margin-right:10px;}
        button:hover{background:#0056b3;}
        button:disabled{background:#c0c0c0;cursor:not-allowed;}
        #load-headers-btn{background:#28a745;} #load-headers-btn:hover{background:#218838;}
        #mapping-fields{display:none;padding-top:15px;}
        .value-field-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
        .value-field-row select,.value-field-row input{width:auto;flex:1;padding:8px 10px;border:1px solid #ccc;border-radius:4px;}
        .value-field-row button{padding:5px 10px;background:#dc3545;font-size:.9em;flex-shrink:0;}
        #add-value-field-btn{background:#17a2b8;}
        .output-section{display:none;}
        .view-tabs{border-bottom:2px solid #dee2e6;margin-bottom:15px;}
        .tab-btn{background:transparent;color:#0056b3;border:none;padding:10px 15px;cursor:pointer;font-size:1.1em;margin-right:5px;border-radius:5px 5px 0 0;transition:.2s;}
        .tab-btn:hover{background:#e6f0ff;}
        .tab-btn.active{background:#0056b3;color:#fff;} .view-pane{display:none;padding:10px;}
        .view-pane.active{display:block;} #item-view select{font-size:1.1em;padding:8px;margin-bottom:15px;}
        #individual-view .individual-report{margin-bottom:30px;border-bottom:2px solid #0056b3;padding-bottom:15px;}
        /* 合併儲存格高亮 */
        .merge-hint{background:#fff3cd;border:2px dashed #ffc107;}
        .text-center{text-align:center;}
        .text-muted{color:#888;}
        /* 進度條 */
        #progress-container{height:22px;background:#e5e9f2;border-radius:8px;overflow:hidden;margin-bottom:8px;display:none;}
        #progress-bar{height:100%;background:#007bff;width:0%;transition:.25s;}
        #progress-text{margin-left:8px;}
    </style>
</head>
<body>
<div id="app-container">
    <h1>基金資料彙總報告產生器 (v9.1-opt)</h1>
    <div class="config-section">
        <h2>1. 上傳多個檔案</h2>
        <div id="drop-area">拖曳 <b>多個</b> Excel 檔案至此，或點擊此處選擇檔案
            <input type="file" id="file-input" accept=".xlsx,.xls" multiple>
        </div>
        <ul id="file-list-display"></ul>
        <div id="progress-container"><div id="progress-bar"></div><span id="progress-text">0%</span></div>
    </div>
    <div class="preview-section">
        <h2>2. 檔案預覽 (僅顯示第一個檔案)</h2>
        <div id="preview-area"><p style="padding:20px;text-align:center;color:#777;">尚未載入檔案</p></div>
    </div>
    <div class="config-section">
        <h2>3. 設定資料範圍與標頭 (將套用至所有檔案)</h2>
        <div class="input-group">
            <label for="data-range">資料範圍 (不含標頭)</label>
            <input type="text" id="data-range" placeholder="例如: A6:G50">
        </div>
        <div class="input-group">
            <label for="header-row">標頭列號 (絕對列號)</label>
            <input type="number" id="header-row" placeholder="例如: 5">
        </div>
        <div class="input-group">
            <button id="load-headers-btn" disabled>讀取標頭</button>
        </div>
    </div>
    <div class="mapping-section">
        <h2>4. 對應欄位</h2>
        <div id="mapping-fields">
            <div class="input-group">
                <label for="map-subject">"項目/科目" 欄位 (主鍵)</label>
                <select id="map-subject"></select>
            </div>
            <div class="input-group">
                <label>"要加總的數值欄位"</label>
                <div id="value-fields-list"></div>
                <button type="button" id="add-value-field-btn" style="margin-top:10px;">+ 新增加總欄位</button>
            </div>
        </div>
        <p id="mapping-placeholder" style="color:#777;">請先讀取標頭以顯示對應選單</p>
    </div>
    <div class="config-section">
        <button id="process-btn" disabled>開始彙總處理</button>
    </div>
    <div class="output-section" id="output-area">
        <h2>5. 彙總報告結果</h2>
        <div class="view-tabs">
            <button class="tab-btn active" data-view="summary-view">加總總表</button>
            <button class="tab-btn" data-view="individual-view">個別檔案</button>
            <button class="tab-btn" data-view="item-view">項目查詢</button>
        </div>
        <div id="view-content">
            <div id="summary-view" class="view-pane active"></div>
            <div id="individual-view" class="view-pane"></div>
            <div id="item-view" class="view-pane">
                <select id="item-dropdown"></select>
                <div id="item-detail-table"></div>
            </div>
        </div>
    </div>
</div>
<script>
const state = {
    workbooks:[], allFileData:[], summaryData:new Map(), processedHeaders:[], 
    mapping:{key:'',values:[]}, reportHeaders:[]
};
// DOM
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
const fileListDisplay = document.getElementById('file-list-display');
const progressContainer=document.getElementById('progress-container');
const progressBar=document.getElementById('progress-bar');
const progressText=document.getElementById('progress-text');
const previewArea=document.getElementById('preview-area');
const dataRangeInput=document.getElementById('data-range'),headerRowInput=document.getElementById('header-row');
const loadHeadersBtn=document.getElementById('load-headers-btn');
const mappingFields=document.getElementById('mapping-fields'),mappingPlaceholder=document.getElementById('mapping-placeholder');
const mapSelects={subject:document.getElementById('map-subject')};
const addValueFieldBtn=document.getElementById('add-value-field-btn'), valueFieldsList=document.getElementById('value-fields-list');
const processBtn=document.getElementById('process-btn');
const outputArea=document.getElementById('output-area'),itemDropdown=document.getElementById('item-dropdown');

//事件監聽初始化
dropArea.addEventListener('click',()=>fileInput.click());
dropArea.addEventListener('dragover',e=>{e.preventDefault();dropArea.style.backgroundColor='#e6f0ff';});
dropArea.addEventListener('dragleave',()=>{dropArea.style.backgroundColor='#f8faff';});
dropArea.addEventListener('drop',e=>{
    e.preventDefault(); dropArea.style.backgroundColor='#f8faff';
    if(e.dataTransfer.files.length>0){
        fileInput.files = e.dataTransfer.files;
        handleFiles(fileInput.files);
    }
});
fileInput.addEventListener('change',e=>{
    if(e.target.files.length>0){handleFiles(e.target.files);}
});
loadHeadersBtn.addEventListener('click',loadHeaders);
processBtn.addEventListener('click',processData);
itemDropdown.addEventListener('change',renderItemDetailView);
addValueFieldBtn.addEventListener('click',addNewValueFieldRow);
valueFieldsList.addEventListener('click',e=>{
    if(e.target.classList.contains('remove-field-btn')){e.target.parentElement.remove();}
});
setupTabs();

//設定記憶
function saveSetting(){localStorage.setItem('excelMergeSettings',JSON.stringify({range:dataRangeInput.value,headerRow:headerRowInput.value}));}
function loadSetting(){try{const c=JSON.parse(localStorage.getItem('excelMergeSettings'));if(c){dataRangeInput.value=c.range;headerRowInput.value=c.headerRow;}}catch{}}
loadSetting();

//檔案讀取&進度
function readFile(file){
    return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>{
            try{const w=XLSX.read(e.target.result,{type:'array'});resolve({file,workbook:w});}catch(err){reject(err);}
        };
        reader.onerror=err=>reject(err);
        reader.readAsArrayBuffer(file);
    });
}

async function handleFiles(fileList){
    if([...fileList].some(f=>f.size>10*1024*1024)){alert('檔案過大，請分批上傳！');return;}
    dropArea.innerHTML='正在讀取與解析檔案...'; previewArea.innerHTML='<p style="padding:20px;text-align:center;">正在讀取與解析檔案...</p>';
    fileListDisplay.innerHTML=''; state.workbooks=[];
    progressBar.style.width="0%";progressText.textContent="0%";progressContainer.style.display="block";
    const filePromises=Array.from(fileList).map(readFile);
    try {
        const results=await Promise.all(filePromises.map((p,i)=>p.then(res=>{
            let pct=Math.round(((i+1)/fileList.length)*100);
            progressBar.style.width=pct+"%";progressText.textContent=pct+"%";
            return res;
        })));
        state.workbooks=results;
        fileListDisplay.innerHTML='已載入檔案：'+state.workbooks.map(wb=>`<li>- ${wb.file.name}</li>`).join('');
        dropArea.innerHTML='點擊或拖曳更換檔案';dropArea.classList.add('minimized');
        progressContainer.style.display="none";
        generatePreview(state.workbooks[0].workbook.Sheets[state.workbooks[0].workbook.SheetNames[0]]);
        loadHeadersBtn.disabled=false;
    }catch(err){
        previewArea.innerHTML=`<p style="padding:20px;text-align:center;color:red;">檔案解析失敗：${err.message}</p>`;
        dropArea.classList.remove('minimized');dropArea.innerHTML='拖曳 <b>多個</b> Excel 檔案至此，或點擊此處選擇檔案';
        progressContainer.style.display="none";
    }
}

//預覽 + 合併格提示優化
function generatePreview(sheet){
    if(!sheet||!sheet['!ref']){
        previewArea.innerHTML='<p class="text-center text-muted">工作表為空</p>';return;
    }
    const fullRange=XLSX.utils.decode_range(sheet['!ref']);
    const minCol=fullRange.s.c,maxCol=fullRange.e.c,minRow=fullRange.s.r,maxRow=fullRange.e.r;
    const merges=sheet['!merges']||[];
    let html='<table><thead><tr><th></th>';
    for(let C=minCol;C<=maxCol;++C)html+='<th>'+XLSX.utils.encode_col(C)+'</th>';
    html+='</tr></thead><tbody>';
    const totalRows=maxRow-minRow+1,colCount=maxCol-minCol+1;
    // 預覽前後5列，中間省略
    const renderRows=(s,e)=>{
        let range={s:{r:s,c:minCol},e:{r:e,c:maxCol}};
        const rows=XLSX.utils.sheet_to_json(sheet,{header:1,range:XLSX.utils.encode_range(range),defval:''});
        rows.forEach((row,rowIdx)=>{
            const excelRowNum=s+rowIdx+1;
            html+='<tr><th>'+excelRowNum+'</th>';
            for(let c=0;c<colCount;c++){
                let cellAddress=XLSX.utils.encode_cell({r:s+rowIdx,c:minCol+c});
                let isMerged=merges.find(m=>(s+rowIdx)>=m.s.r&&(s+rowIdx)<=m.e.r&&(minCol+c)>=m.s.c&&(minCol+c)<=m.e.c);
                html+=`<td${isMerged?' class="merge-hint"':''}>${row[c]!=null?row[c]:''}</td>`;
            }
            html+='</tr>';
        });
    };
    if(totalRows<=11){renderRows(minRow,maxRow);}
    else{renderRows(minRow,minRow+4);html+=`<tr><th>...</th><td colspan="${colCount}" class="omitted-row-cell">... (省略${totalRows-10}列) ...</td></tr>`;renderRows(maxRow-4,maxRow);}
    html+='</tbody></table>'; previewArea.innerHTML=html;
}

//標頭讀取、映射、動態欄位
function loadHeaders(){
    if(state.workbooks.length==0){alert('請先上傳檔案');return;}
    const sheet=state.workbooks[0].workbook.Sheets[state.workbooks[0].workbook.SheetNames[0]];
    const dataRangeStr=dataRangeInput.value.trim(),headerRow=parseInt(headerRowInput.value,10);
    if(!dataRangeStr||!headerRow){alert('請輸入有效範圍與標頭列');return;}
    try{
        saveSetting();
        const range=XLSX.utils.decode_range(dataRangeStr),headerRowIndex=headerRow-1;
        state.processedHeaders=[];
        for(let C=range.s.c;C<=range.e.c;++C){
            const cellAddr=XLSX.utils.encode_cell({r:headerRowIndex,c:C}),
            cell=sheet[cellAddr];
            let headerName=cell&&cell.v?String(cell.v).trim():`(欄${C+1})`;
            state.processedHeaders.push(headerName);
        }
        populateMappingSelects(state.processedHeaders);
        mappingFields.style.display='block';mappingPlaceholder.style.display='none';processBtn.disabled=false;
    }catch(err){alert(`讀取標頭失敗：${err.message}`);}
}

function populateMappingSelects(headers){
    let ops='<option value="--- 請選擇 ---">--- 請選擇 ---</option>';
    headers.forEach(h=>ops+=`<option value="${h}">${h}</option>`);
    mapSelects.subject.innerHTML=ops;
    autoSelectMapping(headers);
}
function autoSelectMapping(headers){
    const found=headers.find(h=>["科目","項目"].some(k=>h.indexOf(k)!==-1));
    if(found)mapSelects.subject.value=found;
}
function addNewValueFieldRow(){
    const row=document.createElement('div');row.className='value-field-row';
    const select=document.createElement('select');select.className='value-field-select';
    const input=document.createElement('input');input.type='text';input.className='value-field-name';input.placeholder='輸入報表欄位名稱(可選)';
    let ops='<option value="">--選擇Excel欄位--</option>';
    state.processedHeaders.forEach(h=>ops+=`<option value="${h}">${h}</option>`);select.innerHTML=ops;
    select.addEventListener('change',()=>{if(!input.value&&select.value)input.value=select.value;});
    const removeBtn=document.createElement('button');removeBtn.type='button';removeBtn.className='remove-field-btn';removeBtn.textContent='移除';
    row.appendChild(select);row.appendChild(input);row.appendChild(removeBtn);valueFieldsList.appendChild(row);
}

//核心處理流程
function processData(){
    state.mapping.key=mapSelects.subject.value;if(state.mapping.key==='--- 請選擇 ---'){alert("請選擇主鍵欄位");return;}
    state.mapping.values=[]; state.reportHeaders=[];
    const valueRows=valueFieldsList.querySelectorAll('.value-field-row');
    if(valueRows.length==0){alert('請新增加總欄');return;}
    valueRows.forEach(row=>{
        const excelHeader=row.querySelector('.value-field-select').value,reportHeader=row.querySelector('.value-field-name').value.trim();
        if(!excelHeader){alert('加總欄必選Excel欄');return;}
        state.mapping.values.push({excelHeader,reportHeader:reportHeader||excelHeader});
    });
    state.reportHeaders=state.mapping.values.map(m=>m.reportHeader);
    const dataRangeStr=dataRangeInput.value.trim();
    //== 處理檔案 ==
    state.allFileData=[];
    state.summaryData=new Map();
    try{
        state.workbooks.forEach(wb=>{
            const sheet=wb.workbook.Sheets[wb.workbook.SheetNames[0]];
            const dataJson=XLSX.utils.sheet_to_json(sheet,{range:dataRangeStr,header:state.processedHeaders});
            const transformed=dataJson.map(row=>{
                const newRow={}; newRow[state.mapping.key]=row[state.mapping.key];
                state.mapping.values.forEach(map=>{newRow[map.reportHeader]=row[map.excelHeader];});
                return newRow;
            }).filter(row=>row[state.mapping.key]);
            state.allFileData.push({fileName:wb.file.name,data:transformed});
        });
        //== 彙總 ==
        state.allFileData.forEach(file=>{
            file.data.forEach(row=>{
                const key=row[state.mapping.key];
                if(!state.summaryData.has(key)){
                    let obj={}; obj[state.mapping.key]=key;
                    state.mapping.values.forEach(map=>obj[map.reportHeader]=toNumber(row[map.reportHeader]));
                    state.summaryData.set(key,obj);
                }else{
                    let obj=state.summaryData.get(key);
                    state.mapping.values.forEach(map=>obj[map.reportHeader]+=toNumber(row[map.reportHeader]));
                }
            });
        });
        renderSummaryView(); renderIndividualViews(); renderItemView();
        outputArea.style.display='block';
        alert(`處理完成！共處理 ${state.workbooks.length} 檔案，彙總了 ${state.summaryData.size} 項目。`);
    }catch(err){alert(`處理資料錯誤：${err.message}`);}
}
function toNumber(v){return(typeof v==='number')?v:parseFloat(v)||0;}

//報表渲染
function generateHtmlTable(data,headers,formatNumbers=false){
    let html='<table class="report-table"><thead><tr>';
    headers.forEach(h=>html+=`<th>${h}</th>`);html+='</tr></thead><tbody>';
    data.forEach(row=>{
        html+='<tr>'; headers.forEach(h=>{
            const val=row[h]; html+=formatNumbers&&typeof val==='number'?`<td class="number">${val.toFixed(2)}</td>`:`<td>${val!=null?val:''}</td>`;
        }); html+='</tr>';
    });
    html+='</tbody></table>'; return html;
}
function renderSummaryView(){
    const view=document.getElementById('summary-view');
    const data=Array.from(state.summaryData.values()),headers=[state.mapping.key,...state.reportHeaders];
    view.innerHTML=generateHtmlTable(data,headers,true);
}
function renderIndividualViews(){
    const view=document.getElementById('individual-view');let html='';
    const headers=[state.mapping.key,...state.reportHeaders];
    state.allFileData.forEach(file=>{
        html+=`<div class="individual-report"><h3>${file.fileName}</h3>${generateHtmlTable(file.data,headers,false)}</div>`;
    });
    view.innerHTML=html;
}
function renderItemView(){
    itemDropdown.innerHTML='<option value="">--- 請選擇要查詢的項目 ---</option>';
    Array.from(state.summaryData.keys()).sort().forEach(item=>{
        itemDropdown.innerHTML+=`<option value="${item}">${item}</option>`;
    });
    document.getElementById('item-detail-table').innerHTML='';
}
function renderItemDetailView(){
    const sel=itemDropdown.value,container=document.getElementById('item-detail-table');
    if(!sel){container.innerHTML='';return;}
    const headers=['檔案名稱',...state.reportHeaders];
    let data=[];
    state.allFileData.forEach(file=>{
        const row=file.data.find(r=>r[state.mapping.key]===sel);
        if(row){
            let d={"檔案名稱":file.fileName};
            state.reportHeaders.forEach(h=>d[h]=toNumber(row[h]));
            data.push(d);
        }
    });
    const srow=state.summaryData.get(sel);
    if(srow){
        let total={"檔案名稱":"<strong>總計</strong>"};state.reportHeaders.forEach(h=>total[h]=srow[h]);data.push(total);
    }
    container.innerHTML=generateHtmlTable(data,headers,true);
}
//頁籤/Tab UI
function setupTabs(){
    document.querySelector('.view-tabs').addEventListener('click',e=>{
        if(e.target.classList.contains('tab-btn')){
            const trg=e.target.dataset.view;
            document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.toggle('active',btn.dataset.view==trg));
            document.querySelectorAll('.view-pane').forEach(p=>p.classList.toggle('active',p.id==trg));
        }
    });
}
</script>
</body>
</html>
