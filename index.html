<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金資料彙總報告產生器 (v6 - 動態欄位通用版)</title>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        /* --- (CSS 樣式保持不變) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 2em;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
        }
        .container { max-width: 1200px; width: 100%; background: white; padding: 2.5em; border-radius: 12px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); }
        h1 { color: #1a2c4e; border-bottom: 3px solid #007bff; padding-bottom: 15px; margin-top: 0; }

        /* --- 拖曳區域樣式 --- */
        #drop-zone { border: 3px dashed #c0cdda; border-radius: 10px; padding: 50px; text-align: center; color: #8a9bb3; font-size: 1.3em; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); margin-bottom: 2em; background-color: #fcfdff; }
        #drop-zone.drag-over { border-color: #007bff; background-color: #e6f2ff; color: #0056b3; transform: scale(1.02); }
        #drop-zone p { margin: 0; font-size: 1.5rem; font-weight: 500;}
        #drop-zone span { font-size: 1rem; }

        /* --- 控制項樣式 --- */
        .controls { margin-bottom: 2em; padding: 1.5em; background-color: #f8f9fa; border-radius: 8px; display: flex; flex-direction: column; gap: 20px; }
        .control-row { display: flex; align-items: center; flex-wrap: wrap; gap: 20px; }
        .control-group { display: flex; align-items: center; gap: 10px; }
        label { font-size: 1.1em; font-weight: 500; white-space: nowrap; }
        select, button, input[type="text"], input[type="number"] { padding: 12px 18px; font-size: 1em; border-radius: 6px; border: 1px solid #ced4da; transition: all 0.2s ease-in-out; }
        select { cursor: pointer; }
        input[type="text"] { flex-grow: 1; min-width: 120px; }
        input[type="number"] { width: 100px; }
        select:focus, button:focus, input:focus { outline: none; border-color: #80bdff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        
        button { background-color: #28a745; color: white; border-color: #28a745; font-weight: 500; cursor: pointer; }
        #download-json-btn { background-color: #007bff; border-color: #007bff; }
        #process-btn { background-color: #fd7e14; border-color: #fd7e14; font-weight: bold; }
        button:hover:not(:disabled) { opacity: 0.85; }
        button:disabled { background-color: #c0cdda; border-color: #c0cdda; cursor: not-allowed; }

        /* --- 模式切換樣式 --- */
        .mode-selector { display: flex; background-color: #e9ecef; border-radius: 6px; padding: 5px; }
        .mode-selector input[type="radio"] { display: none; }
        .mode-selector label { padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: all 0.3s ease; }
        .mode-selector input[type="radio"]:checked + label { background-color: #007bff; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- 狀態和表格樣式 --- */
        #status { margin-bottom: 1.5em; color: #555; font-weight: bold; height: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 1em; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06); border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #e9ecef; padding: 14px 18px; text-align: left; vertical-align: middle; }
        thead { background-color: #007bff; color: white; }
        tbody tr:nth-child(even) { background-color: #f8f9fa; }
        tbody tr:hover { background-color: #e9ecef; }
        td:not(:first-child) { text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <h1>基金資料彙總報告產生器 (v6 - 動態欄位通用版)</h1>
        
        <input type="file" id="file-input" multiple accept=".xlsx, .xls" style="display: none;">
        <div id="drop-zone">
            <p>拖曳 Excel 檔案至此</p>
            <span>或點擊此處選擇檔案</span>
        </div>

        <div class="controls">
            <div class="control-row">
                 <div class="control-group">
                    <label>標頭列 (Row)：</label>
                    <input type="number" id="header-row-input" value="5" min="1" disabled>
                 </div>
                <div class="control-group">
                    <label>資料起始：</label>
                    <select id="start-col-select" disabled></select>
                    <input type="number" id="start-row-input" value="6" min="1" disabled>
                </div>
                <div class="control-group">
                    <label>資料結束：</label>
                    <select id="end-col-select" disabled></select>
                    <input type="number" id="end-row-input" value="63" min="1" disabled>
                </div>
                <button id="process-btn" disabled style="margin-left: auto;">開始處理</button>
            </div>
            
            <hr style="border: none; border-top: 1px solid #e0e0e0; width: 100%; margin: 10px 0;">

            <div class="control-row">
                 <div class="control-group">
                    <label>檢視模式：</label>
                    <div class="mode-selector">
                        <input type="radio" id="mode-individual" name="view-mode" value="individual" checked>
                        <label for="mode-individual">個別摘要</label>
                        <input type="radio" id="mode-sum" name="view-mode" value="sum">
                        <label for="mode-sum">所有檔案加總</label>
                        <input type="radio" id="mode-compare" name="view-mode" value="compare">
                        <label for="mode-compare">單項比較</label>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="control-group" id="fund-select-group">
                    <label for="fund-select">選擇檔案：</label>
                    <select id="fund-select" disabled></select>
                </div>
                <div class="control-group" id="item-select-group" style="display: none;">
                    <label for="item-select">選擇項目：</label>
                    <select id="item-select" disabled></select>
                </div>
                 <button id="download-html-btn" disabled>產生並下載HTML報告</button>
                 <button id="download-json-btn" disabled>匯出JSON檔</button>
            </div>

            <hr style="border: none; border-top: 1px solid #e0e0e0; width: 100%; margin: 10px 0;">
            <div class="control-row" style="flex-wrap: wrap; gap: 25px;">
                 <label style="width: 100%; font-weight: bold; color: #007bff;">JSON 匯出設定 (必填)</label>
                <div class="control-group">
                    <label for="json-item-col">"科目" 欄位：</label>
                    <select id="json-item-col" disabled></select>
                </div>
                <div class="control-group">
                    <label for="json-prev-col">"前年度決算數" 欄位：</label>
                    <select id="json-prev-col" disabled></select>
                </div>
                 <div class="control-group">
                    <label for="json-last-col">"上年度預算數" 欄位：</label>
                    <select id="json-last-col" disabled></select>
                </div>
                <div class="control-group">
                    <label for="json-current-col">"本年度預算數" 欄位：</label>
                    <select id="json-current-col" disabled></select>
                </div>
            </div>

        </div>
        
        <div id="status"></div>
        <div id="table-container"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM 元素 ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const statusDiv = document.getElementById('status');
        const tableContainer = document.getElementById('table-container');

        // --- (v6) DOM 元素 ---
        const headerRowInput = document.getElementById('header-row-input'); // v6 新增
        const startColSelect = document.getElementById('start-col-select');
        const startRowInput = document.getElementById('start-row-input');
        const endColSelect = document.getElementById('end-col-select');
        const endRowInput = document.getElementById('end-row-input');
        const processBtn = document.getElementById('process-btn');
        
        // --- (v6) JSON 對應 DOM ---
        const jsonItemCol = document.getElementById('json-item-col');
        const jsonPrevCol = document.getElementById('json-prev-col');
        const jsonLastCol = document.getElementById('json-last-col');
        const jsonCurrentCol = document.getElementById('json-current-col');
        const jsonSelects = [jsonItemCol, jsonPrevCol, jsonLastCol, jsonCurrentCol];

        // 檢視模式 & 下拉選單
        const modeRadios = document.querySelectorAll('input[name="view-mode"]');
        const fundSelect = document.getElementById('fund-select');
        const itemSelect = document.getElementById('item-select');
        const fundSelectGroup = document.getElementById('fund-select-group');
        const itemSelectGroup = document.getElementById('item-select-group');
        
        // 匯出按鈕
        const downloadHtmlBtn = document.getElementById('download-html-btn');
        const downloadJsonBtn = document.getElementById('download-json-btn');

        // --- 全域變數 ---
        let allData = []; 
        let fundNames = []; 
        let itemNames = [];
        let uploadedFiles = null; 
        
        let FIXED_HEADERS = [];
        let ROWS_PER_FILE = 0; 

        // --- 填充 A-Z 下拉選單 ---
        function populateColumnSelects() {
            const selects = [startColSelect, endColSelect];
            selects.forEach(select => {
                select.innerHTML = '';
                for (let i = 0; i < 26; i++) {
                    const colLetter = String.fromCharCode(65 + i); // 'A'
                    const option = document.createElement('option');
                    option.value = colLetter;
                    option.textContent = colLetter;
                    select.appendChild(option);
                }
            });
            startColSelect.value = 'A';
            endColSelect.value = 'I';
        }
        
        // --- 設定事件監聽 ---
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, preventDefaults, false));
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false));
        ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false));
        dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
        
        fundSelect.addEventListener('change', refreshTable);
        itemSelect.addEventListener('change', refreshTable);
        modeRadios.forEach(radio => radio.addEventListener('change', refreshTable));
        downloadHtmlBtn.addEventListener('click', generateAndDownloadHtml);
        downloadJsonBtn.addEventListener('click', generateAndDownloadJson);

        processBtn.addEventListener('click', startProcessing);

        // --- 立即執行 ---
        populateColumnSelects(); // 頁面載入時填充 A-Z 選單

        // --- 主要功能函式 ---

        /**
         * (v6) `handleFiles` 啟用手動輸入 UI
         */
        function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            uploadedFiles = files;
            
            resetUI(false); 
            statusDiv.textContent = `已選擇 ${files.length} 個檔案。請確認標頭與資料範圍後點擊處理。`;
            
            // 啟用所有 v6 輸入
            headerRowInput.disabled = false;
            startColSelect.disabled = false;
            startRowInput.disabled = false;
            endColSelect.disabled = false;
            endRowInput.disabled = false;
            processBtn.disabled = false;
        }

        /**
         * *** 修改點 (3) ***
         * `startProcessing` - v6 核心邏輯
         * 動態讀取標頭，不再驗證 9 欄
         */
        async function startProcessing() {
            if (!uploadedFiles || uploadedFiles.length === 0) {
                alert("請先上傳檔案。");
                return;
            }

            // 1. 從 UI 獲取所有範圍設定
            const headerRow = parseInt(headerRowInput.value, 10);
            const startCol = startColSelect.value;
            const startRow = parseInt(startRowInput.value, 10);
            const endCol = endColSelect.value;
            const endRow = parseInt(endRowInput.value, 10);

            // 2. 驗證範圍
            if (isNaN(headerRow) || headerRow <= 0) {
                alert("請輸入有效的標頭列編號！");
                return;
            }
            if (isNaN(startRow) || isNaN(endRow) || startRow <= headerRow || endRow < startRow) {
                alert("請輸入有效的資料起始/結束列數！(資料起始列必須 > 標頭列)");
                return;
            }
            const startColIndex = XLSX.utils.decode_col(startCol);
            const endColIndex = XLSX.utils.decode_col(endCol);
            if (endColIndex < startColIndex) {
                alert("結束欄位必須在起始欄位之後！");
                return;
            }

            // 3. 重置 UI 並開始處理
            resetUI(false); 
            statusDiv.textContent = `處理中... 正在讀取第一個檔案的標頭...`;
            processBtn.disabled = true;

            const dataRange = `${startCol}${startRow}:${endCol}${endRow}`;
            const headerRange = `${startCol}${headerRow}:${endCol}${headerRow}`; // e.g., A5:I5

            try {
                // 4. 動態讀取標頭 (從第一個檔案)
                const firstFile = uploadedFiles[0];
                const workbook = await readFileAsWorkbook(firstFile);
                const firstSheetName = workbook.SheetNames[0];
                const mainSheet = workbook.Sheets[firstSheetName];

                // 讀取標頭列的資料
                const headerData = XLSX.utils.sheet_to_json(mainSheet, { header: 1, range: headerRange, defval: null });
                
                if (!headerData || headerData.length === 0 || !headerData[0]) {
                     throw new Error(`在 ${headerRange} 範圍內找不到標頭資料。`);
                }

                // 5. 設定全域變數
                FIXED_HEADERS = headerData[0].map(h => h ? String(h).trim() : `(空欄位 ${headerRange})`);
                ROWS_PER_FILE = endRow - startRow + 1;

                // 6. *** v6 核心 ***
                // 用讀取到的標頭，填充 JSON 下拉選單
                populateJsonSelects(FIXED_HEADERS);
                jsonSelects.forEach(s => s.disabled = false);

            } catch (error) {
                statusDiv.textContent = `讀取標頭時發生錯誤：${error.message}`;
                console.error(error);
                processBtn.disabled = false;
                return;
            }


            // 7. 標頭讀取成功，開始處理所有檔案
            statusDiv.textContent = `標頭讀取完成。正在處理 ${uploadedFiles.length} 個檔案...`;
            const filePromises = Array.from(uploadedFiles).map(file => processFile(file, dataRange));

            Promise.all(filePromises)
                .then(() => {
                    fundNames.sort();
                    itemNames.sort();
                    statusDiv.textContent = `處理完成！共 ${fundNames.length} 個檔案。`;
                    populateDropdowns();
                    if (allData.length > 0) {
                        refreshTable();
                        downloadHtmlBtn.disabled = false;
                        downloadJsonBtn.disabled = false;
                    }
                    processBtn.disabled = false; 
                })
                .catch(error => {
                    statusDiv.textContent = `處理檔案時發生錯誤：${error.message}`;
                    console.error(error);
                    processBtn.disabled = false;
                });
        }
        
        /**
         * (v5) `processFile` - 只需讀取檔案，不需改動
         */
        function processFile(file, dataRange) {
             return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const mainSheet = workbook.Sheets[firstSheetName];
                        
                        const fileExtensionRegex = /\.(xlsx|xls)$/i;
                        const fundName = file.name.replace(fileExtensionRegex, "").trim();

                        if (!fundNames.includes(fundName)) fundNames.push(fundName);

                        // 核心：使用使用者指定的 dataRange 讀取資料
                        const rows = XLSX.utils.sheet_to_json(mainSheet, { header: 1, range: dataRange, defval: null });

                        const records = rows.map(rowArray => {
                            const record = { '檔案名稱': fundName }; 
                            // 核心：使用動態讀取的 FIXED_HEADERS
                            FIXED_HEADERS.forEach((header, index) => {
                                record[header] = rowArray[index];
                            });
                            const itemName = record[FIXED_HEADERS[0]]; // 第一欄 (錨點欄)
                            if (itemName && !itemNames.includes(itemName)) {
                                itemNames.push(itemName);
                            }
                            return record;
                        });
                        
                        allData.push(...records);
                        resolve();
                    } catch (err) {
                        reject(new Error(`解析 ${file.name} 失敗 (範圍 ${dataRange}): ${err.message}`));
                    }
                };
                reader.onerror = () => reject(new Error(`讀取 ${file.name} 失敗`));
                reader.readAsArrayBuffer(file);
            });
        }
        
        /**
         * *** 新函式 (B) ***
         * `readFileAsWorkbook` - 輔助函式 (來自 v3)
         */
        function readFileAsWorkbook(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'array' });
                        resolve(workbook);
                    } catch (err) {
                        reject(new Error(`解析 ${file.name} 失敗: ${err.message}`));
                    }
                };
                reader.onerror = () => reject(new Error(`讀取 ${file.name} 失敗`));
                reader.readAsArrayBuffer(file);
            });
        }

        /**
         * *** 新函式 (C) ***
         * `populateJsonSelects` - v6 核心
         * 填充 JSON 對應的下拉選單
         */
        function populateJsonSelects(headers) {
            jsonSelects.forEach(select => {
                select.innerHTML = ''; // 清空
                headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    select.appendChild(option);
                });
            });

            // 嘗試根據 v4/v5 的假設設定預設值 (如果欄位存在)
            // 這是為了方便使用者，即使失敗也沒關係
            if (headers[0]) jsonItemCol.value = headers[0];
            if (headers[1]) jsonPrevCol.value = headers[1];
            if (headers[2]) jsonLastCol.value = headers[2];
            if (headers[7]) jsonCurrentCol.value = headers[7];
        }


        function resetUI(fullReset = true) {
            allData = [];
            fundNames = [];
            itemNames = [];
            [fundSelect, itemSelect, downloadHtmlBtn, downloadJsonBtn].forEach(el => el.disabled = true);
            tableContainer.innerHTML = '';
            
            // 禁用 JSON 下拉選單
            jsonSelects.forEach(s => {
                s.innerHTML = '';
                s.disabled = true;
            });

            if (fullReset) {
                uploadedFiles = null;
                processBtn.disabled = true;
                fileInput.value = ''; // 清除已選擇的檔案
                
                // 禁用所有 v6 輸入
                headerRowInput.disabled = true;
                startColSelect.disabled = true;
                startRowInput.disabled = true;
                endColSelect.disabled = true;
                endRowInput.disabled = true;

                // 恢復預設值
                headerRowInput.value = 5;
                startColSelect.value = 'A';
                startRowInput.value = 6;
                endColSelect.value = 'I';
                endRowInput.value = 63;
            }
        }
        
        // --- (v5) 後續函式修改 ---
        // --- `populateDropdowns`, `refreshTable`, `display...`, `createTable`, `formatNumber` ---
        // --- 這些函式 *完全不需要* 修改，因為它們都正確依賴 `FIXED_HEADERS` ---
        
        function populateDropdowns() {
            const populate = (selectEl, options) => {
                const currentVal = selectEl.value;
                selectEl.innerHTML = '';
                if (options.length === 0) {
                    selectEl.innerHTML = '<option>無可用選項</option>';
                    selectEl.disabled = true;
                    return;
                }
                options.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    selectEl.appendChild(option);
                });
                selectEl.value = currentVal;
                if(selectEl.selectedIndex === -1) selectEl.selectedIndex = 0;
                selectEl.disabled = false;
            };

            populate(fundSelect, fundNames);
            populate(itemSelect, itemNames);
        }

        function refreshTable() {
            const selectedMode = document.querySelector('input[name="view-mode"]:checked').value;
            if (allData.length === 0) return;

            fundSelectGroup.style.display = selectedMode === 'individual' ? 'flex' : 'none';
            itemSelectGroup.style.display = selectedMode === 'compare' ? 'flex' : 'none';
            
            tableContainer.innerHTML = '';
            switch (selectedMode) {
                case 'individual':
                    displayIndividualFundTable(fundSelect.value);
                    break;
                case 'sum':
                    displayAggregatedTable();
                    break;
                case 'compare':
                    displayItemComparisonTable(itemSelect.value);
                    break;
            }
        }

        function displayIndividualFundTable(fundName) {
            const records = allData.filter(r => r['檔案名稱'] === fundName); 
            if (!records || records.length === 0) {
                tableContainer.innerHTML = `<p>找不到檔案「${fundName}」的資料。</p>`;
                return;
            }
            const table = createTable(FIXED_HEADERS);
            const tbody = table.querySelector('tbody');
            records.forEach(record => {
                const row = document.createElement('tr');
                FIXED_HEADERS.forEach(header => {
                    const cell = document.createElement('td');
                    cell.textContent = formatNumber(record[header]);
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
        }

        function displayAggregatedTable() {
            if (!allData || allData.length === 0) {
                tableContainer.innerHTML = `<p>沒有可加總的資料。</p>`;
                return;
            }
            
            const summaryData = [];
            // ROWS_PER_FILE 在 startProcessing 中已設定
            for (let i = 0; i < ROWS_PER_FILE; i++) {
                const summaryRow = {};
                // FIXED_HEADERS 在 startProcessing 中已設定
                FIXED_HEADERS.forEach((header, headerIndex) => {
                    if (headerIndex === 0) {
                        summaryRow[header] = allData[i]?.[header];
                        return;
                    }
                    let sum = 0;
                    fundNames.forEach((fund, fundIndex) => {
                        const recordIndex = fundIndex * ROWS_PER_FILE + i;
                        const value = allData[recordIndex]?.[header];
                        if (typeof value === 'number' && !isNaN(value)) sum += value;
                    });
                    summaryRow[header] = sum;
                });
                summaryData.push(summaryRow);
            }

            const table = createTable(FIXED_HEADERS);
            const tbody = table.querySelector('tbody');
            summaryData.forEach(record => {
                const row = document.createElement('tr');
                FIXED_HEADERS.forEach(header => {
                    const cell = document.createElement('td');
                    cell.textContent = formatNumber(record[header]);
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
        }

        function displayItemComparisonTable(itemName) {
            if (!allData || allData.length === 0 || !itemName) {
                tableContainer.innerHTML = `<p>無法進行項目比較。</p>`;
                return;
            }
            const firstColumnHeader = FIXED_HEADERS[0];
            const comparisonHeaders = ['檔案名稱', ...FIXED_HEADERS.slice(1)]; 
            const table = createTable(comparisonHeaders);
            const tbody = table.querySelector('tbody');

            fundNames.forEach(fund => {
                const itemRowData = allData.find(r => r['檔案名稱'] === fund && r[firstColumnHeader] === itemName);
                const row = document.createElement('tr');
                
                let cell = document.createElement('td');
                cell.textContent = fund;
                row.appendChild(cell);

                comparisonHeaders.slice(1).forEach(header => {
                    cell = document.createElement('td');
                    const value = itemRowData ? itemRowData[header] : '-';
                    cell.textContent = formatNumber(value);
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
        }

        function createTable(headers) {
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const headerRow = document.createElement('tr');
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            table.appendChild(tbody);
            return table;
        }

        function formatNumber(value) {
            if (typeof value === 'number' && !isNaN(value)) {
                return Math.round(value).toLocaleString('en-US');
            }
            return value != null ? value : '';
        }
        
        // (v5) `generateAndDownloadHtml` - 不需修改
        function generateAndDownloadHtml() {
            const selectedMode = document.querySelector('input[name="view-mode"]:checked').value;
            let modeText = '';
            let subTitle = ``;

            switch (selectedMode) {
                case 'individual':
                    modeText = '個別檔案摘要報告'; 
                    subTitle = `檔案：${fundSelect.value}`; 
                    break;
                case 'sum':
                    modeText = '所有檔案加總報告'; 
                    break;
                case 'compare':
                    modeText = '單項比較報告';
                    subTitle = `比較項目：${itemSelect.value}`;
                    break;
            }
            
            const tableHtml = tableContainer.innerHTML;
            if (!tableHtml || tableHtml.startsWith('<p>')) {
                alert('沒有可匯出的資料！');
                return;
            }

            const styles = document.querySelector('style').innerHTML;
            const htmlContent = `
                <!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>${modeText}</title><style>${styles}</style></head>
                <body><div class="container"><h1>${modeText}</h1><h2>${subTitle}</h2>${tableHtml}</div></body></html>`;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const safeFilename = modeText.replace(/[\\/*?:"<>|]/g, '_');
            link.download = `${safeFilename}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        /**
         * *** 修改點 (4) ***
         * `generateAndDownloadJson` - v6 核心
         * 讀取 JSON 對應下拉選單的值，不再依賴索引
         */
        function generateAndDownloadJson() {
            if (allData.length === 0) {
                alert('沒有可匯出的資料！');
                return;
            }
            
            // *** v6 核心：從下拉選單讀取使用者指定的 "標頭名稱" ***
            const itemHeader = jsonItemCol.value;
            const prevYearHeader = jsonPrevCol.value;
            const lastYearHeader = jsonLastCol.value;
            const currentYearHeader = jsonCurrentCol.value;

            // 驗證使用者是否已完成設定
            if (!itemHeader || !prevYearHeader || !lastYearHeader || !currentYearHeader) {
                alert("匯出 JSON 失敗：請在 'JSON 匯出設定' 中，將所有欄位都對應到讀取到的標頭！");
                return;
            }

            const jsonData = allData.map(record => {
                return {
                    "基金名稱": record['檔案名稱'], // (v5)
                    "科目": record[itemHeader],
                    "本年度預算數": record[currentYearHeader],
                    "上年度預算數": record[lastYearHeader],
                    "前年度決算數": record[prevYearHeader]
                };
            });

            const jsonString = JSON.stringify(jsonData, null, 2);

            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `基金資料匯出_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }
    });
    </script>
</body>
</html>
